<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HGPT Steel ‚Äî In tem tr√¨nh m·∫´u (70√ó35mm)</title>
  <style>
    :root{
      --page-w: 70mm;
      --page-h: 35mm;
      --pad: 2mm;
      --gap: 2mm;
      --font: "Times New Roman", Times, serif;
    }
    *{ box-sizing: border-box; }
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#f3f5f8; color:#0f172a; }
    .wrap{ max-width:960px; margin:24px auto; padding:16px; background:#fff; border-radius:14px; box-shadow:0 8px 24px rgba(2,6,23,.08); }
    h1{ font-size:20px; margin:0 0 12px; }
    .row{ display:flex; gap:12px; align-items:center; margin-bottom:8px; flex-wrap:wrap; }
    button, a.link{
      padding:10px 18px; border-radius:10px; border:2px solid #ffad56; background:#fff; color:#ff7a00;
      font-weight:700; cursor:pointer; text-decoration:none;
    }
    button:hover, a.link:hover{ background:#ffad56; color:#fff; }
    .status{ font-size:16px; color:#475569; margin-left:8px; }
    .note{ font-size:14px; color:#64748b; margin-top:4px; }

    .print-container{ display:none; }

    @media print{
      @page{ size: var(--page-w) var(--page-h); margin:0; }
      body *{ visibility:hidden }
      .print-container, .print-container *{ visibility:visible }
      .print-container{position: absolute; inset: 0; display: block;
      }

      .label{
        width:var(--page-w);
        height:var(--page-h);
        /* page-break-after:always; */
        margin:0;
        /* padding:var(--pad); */
        padding: 4mm var(--pad) var(--pad) var(--pad);  /* gi·∫£m ƒë·ªám ƒë·ªÉ s√°t m√©p tr√™n, top right bottom left, ch·ªânh ch·ªó n√†o th√¨ thay var(--pad) b·∫±ng ..mm */
        display:flex;
        /* ƒê√ÇY L√Ä ƒêI·ªÇM CH√çNH: b√°m l√™n top thay v√¨ gi·ªØa */
        align-items: flex-start;
        /* align-items:center; */
        justify-content:flex-start;
        background:#fff;
        break-inside: avoid;
      }
      .label + .label{ break-before: page; }   /* ho·∫∑c page-break-before: always; */
      .text{ line-height:1.06; width:100%; }
      .stt{ font-family:var(--font); font-size:10pt; font-weight:700; color:#555; margin-bottom:1mm; }
      .ten{ font-family:var(--font); font-weight:600; font-size:12.5pt; text-transform:uppercase; }
      .meta{ font-family:var(--font); font-size:10.5pt; margin-top:1mm; }
      .meta b{ font-weight:700; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>HGPT STEEL ‚Äî In tem tr√¨nh m·∫´u CƒêT</h1>
    <div class="row">
      <button id="btnPrint">üñ®Ô∏è IN TEM</button>
      <a href="https://docs.google.com/spreadsheets/d/1NfxVAG9r1i6-Kb5GoxPSQ9yN2RmEi6SLeNlVRFzHAE0/edit?usp=sharing" class="link" target="_blank">üîó M·ªü Sheet n·ªÅn</a>
      <span class="status" id="status">S·∫µn s√†ng</span>
    </div>
    <div class="note">
      Ngu·ªìn d·ªØ li·ªáu: Google Sheet <b>Sheet1</b> g·ªìm c·ªôt <b>STT</b>, <b>CHUNGLOAI</b>, <b>VATLIEU</b>, <b>VITRI</b>, <b>SOLUONG</b>.<br>
      In theo th·ª© t·ª± STT tƒÉng d·∫ßn.
    </div>
  </div>

  <div class="print-container" id="printContainer"></div>

  <script>
  // ====== C·∫§U H√åNH ======
  const GOOGLE_SHEET_ID = '1NfxVAG9r1i6-Kb5GoxPSQ9yN2RmEi6SLeNlVRFzHAE0';
  const SHEET_NAME = 'Sheet1';

  document.addEventListener('DOMContentLoaded', () => {
    const $ = (s)=>document.querySelector(s);
    const statusEl = $('#status');
    const printContainer = $('#printContainer');
    const sheetLink = $('#sheetLink');
    const btnPrint = $('#btnPrint');

    // G√°n link sheet (c√≥ guard ƒë·ªÉ kh√¥ng n√©m l·ªói)
    if (sheetLink) {
      sheetLink.href = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/edit#gid=0`;
    }

    async function fetchSheetGViz(sheetId, sheetName){
      const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
      const resp = await fetch(url);
      const text = await resp.text();
      const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
      const headers = (json.table.cols || []).map((c, i) => (c && c.label) ? c.label : `Col${i+1}`);
      const rows = [];
      for (const r of json.table.rows){
        if (!r || !r.c) continue;
        const o = {};
        headers.forEach((h, i) => { o[h] = r.c[i] ? (r.c[i].v ?? '') : ''; });
        rows.push(o);
      }
      return rows;
    }

    const norm = s => String(s||'').toLowerCase().replace(/\s+/g,'');
    function pick(obj, names){
      const keys = Object.keys(obj);
      for (const want of names){
        const hitKey = keys.find(k => norm(k) === norm(want));
        if (hitKey !== undefined) return obj[hitKey];
      }
      return '';
    }

    async function printFromSheet(){
      statusEl.textContent = 'ƒêang t·∫£i d·ªØ li·ªáu Sheet...';
      printContainer.innerHTML = '';

      let rows;
      try{
        rows = await fetchSheetGViz(GOOGLE_SHEET_ID, SHEET_NAME);
      }catch(e){
        statusEl.textContent = 'L·ªói t·∫£i Sheet';
        alert('Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c d·ªØ li·ªáu Google Sheet:\n' + e.message);
        return;
      }

      if (!rows.length){
        statusEl.textContent = 'Kh√¥ng c√≥ d·ªØ li·ªáu.';
        alert('Sheet tr·ªëng ho·∫∑c kh√¥ng c√≥ h√†ng d·ªØ li·ªáu.');
        return;
      }

      // sort theo STT
      rows.sort((a,b)=>{
        const A = Number(pick(a, ['STT','stt'])) || 0;
        const B = Number(pick(b, ['STT','stt'])) || 0;
        return A - B;
      });

      statusEl.textContent = 'ƒêang t·∫°o tem...';
      const frag = document.createDocumentFragment();
      let total = 0;

      for (const r of rows){
        const STT = pick(r, ['STT','stt']);
        const CHUNGLOAI = String(pick(r, ['CHUNGLOAI','Ch·ªßng lo·∫°i','chungloai'])||'').trim();
        const VATLIEU   = String(pick(r, ['VATLIEU','V·∫≠t li·ªáu','vatlieu'])||'').trim();
        const VITRI     = String(pick(r, ['VITRI','V·ªã tr√≠','vitri'])||'').trim();
        const SLraw     = pick(r, ['SOLUONG','Soluong','SL','soluong']);
        const SL        = Number.parseInt(SLraw,10) > 0 ? Number.parseInt(SLraw,10) : 0;

        if (!CHUNGLOAI || SL === 0) continue;

        for (let i=0; i<SL; i++){
          total++;
          const page = document.createElement('div');
          page.className = 'label';
          page.innerHTML = `
            <div class="text">
              <div class="stt">STT: ${STT || ''}</div>
              <div class="ten">${CHUNGLOAI.toUpperCase()}</div>
              <div class="meta">
                <b>VL:</b> ${VATLIEU || ''} &nbsp;|&nbsp;
                <b>VT:</b> ${VITRI || ''}
              </div>
            </div>`;
          frag.appendChild(page);
        }
      }

      if (!total){
        statusEl.textContent = 'Kh√¥ng c√≥ b·∫£n ghi h·ª£p l·ªá.';
        alert('Thi·∫øu CHUNGLOAI ho·∫∑c SOLUONG = 0 ·ªü m·ªçi h√†ng.');
        return;
      }

      printContainer.appendChild(frag);
      statusEl.textContent = `ƒê√£ t·∫°o ${total} tem ‚Ä¢ m·ªü h·ªôp tho·∫°i in...`;
      setTimeout(()=>{ window.print(); statusEl.textContent = 'S·∫µn s√†ng'; }, 120);
    }

    // G·∫Øn s·ª± ki·ªán sau khi DOM s·∫µn s√†ng
    if (btnPrint) btnPrint.addEventListener('click', printFromSheet);
  });
</script>
</body>
</html>
