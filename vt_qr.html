<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HGPT Steel - VT_QR</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
      background: #f5f7fa;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 20px;
    }

    h1 { margin-bottom: 20px; color: #ff6b35; }

    button {
      background: #ff6b35;
      border: none;
      color: white;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      margin-bottom: 20px;
    }
    button:hover { background: #ff8535; }

    .print-container { display: none; }

    /* ===== PRINT STYLES ===== */
    @media print {
      @page { size: 70mm 35mm; margin: 0; }

      body { margin: 0 !important; padding: 0 !important; background: #fff !important; }
      body * { visibility: hidden; }

      .print-container,
      .print-container * { visibility: visible; }

      .print-container {
        position: absolute;
        left: 0; top: 0;
        width: 100% !important;
        height: 100% !important;
        display: block !important;   /* b·∫Øt bu·ªôc ƒë·ªÉ hi·ªán container */
        margin: 0 !important;
        padding: 0 !important;
      }

      .label-page.vtqr {
        width: 70mm;
        height: 35mm;
        page-break-after: always;
        margin: 0;
        padding: 2mm 2mm 2mm 2mm;
        box-sizing: border-box;
        display: flex;
        align-items: center;
        gap: 3mm;
        background: #fff;
      }

      .vtqr-qr {
        width: 14mm;
        height: 14mm;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .vtqr-qr img {
        width: 14mm !important;
        height: 14mm !important;
        max-width: 14mm !important;
        max-height: 14mm !important;
      }

      .vtqr-text {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        line-height: 1.05;
      }
      .vtqr-mahang {
        font-family: "Times New Roman", Times, serif;
        font-size: 13.5pt;
        font-weight: 700;
        color: #000;
        letter-spacing: 0.5px;
        word-break: break-word;
      }
      .vtqr-tenmau {
        font-family: "Times New Roman", Times, serif;
        font-size: 13.5pt;
        font-weight: 700;
        color: #000;
        letter-spacing: 0.5px;
        word-break: break-word;
        text-transform: uppercase;
      }
    }
  </style>
</head>
<body>
  <h1>In Tem VT_QR</h1>
  <button onclick="printVTQR_All()">üñ®Ô∏è In To√†n B·ªô Tem</button>

  <div class="print-container" id="printContainer"></div>

  <script>
    // ===== AppSheet API Config =====
    const appId = '977c97bd-47e4-441c-b564-fe28574e9d74';
    const accessKey = 'V2-sJNk8-IQldL-7uQ80-Iekic-SvMjg-DFCgG-v97aL';
    const region = 'www';

    // Helper l·∫•y c·ªôt theo nhi·ªÅu t√™n
    function pickField(obj, names = []) {
      for (const n of names) {
        if (obj[n] !== undefined && obj[n] !== null && obj[n] !== '') return obj[n];
        const lc = n.toLowerCase();
        const hit = Object.keys(obj).find(k => k.toLowerCase() === lc);
        if (hit && obj[hit] !== '') return obj[hit];
      }
      return '';
    }

    async function fetchVTQRData() {
      const url = `https://${region}.appsheet.com/api/v2/apps/${appId}/tables/VT_QR/Action`;

      async function call(selector) {
        const resp = await fetch(url, {
          method: 'POST',
          headers: {
            'ApplicationAccessKey': accessKey,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ Action: 'Find', Properties: {}, Selector: selector })
        });
        const text = await resp.text();
        if (!resp.ok) throw new Error(`VT_QR HTTP ${resp.status} - ${text.slice(0,200)}`);
        let data;
        try { data = JSON.parse(text); } catch(e) { throw new Error('JSON parse error'); }
        if (!Array.isArray(data)) throw new Error('Data kh√¥ng ph·∫£i m·∫£ng');
        return data;
      }

      try {
        let data = await call(`Filter(VT_QR, true)`);
        if (data.length === 0) data = await call(`Select(VT_QR[_THISROW], true)`);

        if (data.length > 0) {
          console.log('[VT_QR] rows:', data.length);
          console.log('[VT_QR] sample keys:', Object.keys(data[0]));
        } else {
          console.warn('[VT_QR] Empty array returned');
        }
        return data;
      } catch(e) {
        console.error('fetchVTQRData error:', e);
        alert('Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c d·ªØ li·ªáu VT_QR:\n' + e.message);
        return [];
      }
    }

    function qrFromMahang(mahang, size=600) {
      const v = (mahang||'').toString().trim();
      return `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encodeURIComponent(v)}`;
    }

    async function printVTQR_All() {
      const printContainer = document.getElementById('printContainer');
      printContainer.innerHTML = '';

      const rows = await fetchVTQRData();
      if (!rows || rows.length === 0) {
        alert('Kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá trong VT_QR.');
        return;
      }

      let labelCount = 0;
      const frag = document.createDocumentFragment();

      for (const r of rows) {
        const MAHANG = (pickField(r, ['MAHANG','MaHang','M√É H√ÄNG']) || '').toString().trim();
        const TENMAU = (pickField(r, ['TENMAU','Tenmau','T√™n m·∫´u']) || '').toString().trim();
        const SLraw = pickField(r, ['SL','SoLuong','S·ªë l∆∞·ª£ng']);
        const SL = parseInt(SLraw || 1,10) || 1;

        if (!MAHANG) continue;

        for (let i=0; i<SL; i++) {
          labelCount++;
          const page = document.createElement('div');
          page.className = 'label-page vtqr';
          const qrURL = qrFromMahang(MAHANG,600);

          page.innerHTML = `
            <div class="vtqr-qr"><img src="${qrURL}" alt="QR"></div>
            <div class="vtqr-text">
              <div class="vtqr-mahang">${MAHANG}</div>
              <div class="vtqr-tenmau">${TENMAU}</div>
            </div>`;
          frag.appendChild(page);
        }
      }

      if (labelCount===0) {
        alert('C√≥ d·ªØ li·ªáu nh∆∞ng kh√¥ng t√¨m th·∫•y c·ªôt MAHANG/SL ph√π h·ª£p.\nXem console (F12) ƒë·ªÉ ki·ªÉm tra t√™n c·ªôt th·ª±c t·∫ø.');
        return;
      }

      printContainer.appendChild(frag);

      const imgs = printContainer.querySelectorAll('img');
      if (imgs.length>0) {
        await Promise.all(Array.from(imgs).map(img => new Promise(res => {
          if (img.complete) res(); else { img.onload=res; img.onerror=res; }
        })));
      }
      setTimeout(()=>window.print(),200);
    }
  </script>
</body>
</html>
