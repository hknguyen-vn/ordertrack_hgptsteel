<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HGPT Steel ‚Äî In tem VT_QR (70√ó35mm)</title>
  <style>
    :root {
      --page-w: 70mm;
      --page-h: 35mm;
      --pad: 2mm;
      --gap: 3mm;
      --qr: 15mm;          /* k√≠ch th∆∞·ªõc QR size lon*/
      --font: "Times New Roman", Times, serif;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: #f3f5f8; color: #0f172a; }
    .wrap { max-width: 960px; margin: 24px auto; padding: 16px; background: #fff; border-radius: 14px; box-shadow: 0 8px 24px rgba(2,6,23,.08); }
    h1 { font-size: 20px; margin: 0 0 12px; }
    .row { display: flex; gap: 12px; align-items: center; margin-bottom: 8px; }
    button {
      padding: 10px 18px; border-radius: 10px; border: 2px solid #ffad56; background: #fff; color: #ff7a00;
      font-weight: 700; cursor: pointer;
    }
    button:hover { background: #ffad56; color: #fff; }
    .status { font-size: 13px; color: #475569; margin-left: 8px; }
    .note { font-size: 12px; color: #64748b; margin-top: 4px; }

    /* Khu in */
    .print-container { display: none; }

   @media print {
  @page { size: var(--page-w) var(--page-h); margin: 0; }
  body { background: #fff; }
  body * { visibility: hidden; }
  .print-container, .print-container * { visibility: visible; }
  .print-container { position: absolute; inset: 0; display: block; }

  .label { 
    width: var(--page-w); height: var(--page-h);
    page-break-after: always; margin: 0; padding: var(--pad);
    display: flex;
    align-items: center;      /* canh gi·ªØa theo chi·ªÅu d·ªçc */
    justify-content: flex-start;  /* gi·ªØ QR + text s√°t b√™n tr√°i */
    gap: var(--gap);
    background: #fff;
  }

  .qr { width: var(--qr); height: var(--qr); display: flex; align-items: center; justify-content: center; }
  .qr img { width: var(--qr); height: var(--qr); display: block; }

  .text { display: flex; flex-direction: column; justify-content: center; line-height: 1.1; }
  .ma  { font-family: var(--font); font-weight: 700; font-size: 14pt; }
  .ten { font-family: var(--font); font-weight: 700; font-size: 12pt; text-transform: uppercase; }
}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>HGPT STEEL ‚Äî In tem VT_QR</h1>
    <div class="row">
      <button id="btnPrint">üñ®Ô∏è In tem VT_QR</button>
      <span class="status" id="status">S·∫µn s√†ng</span>
    </div>
    <div class="note">Tem 70√ó35mm, QR b√™n tr√°i (t·ª´ c·ªôt <b>MAHANG</b>), b√™n ph·∫£i: <b>MAHANG</b> v√† <b>TENMAU</b> (in hoa), nh√¢n b·∫£n theo <b>SL</b>.</div>
  </div>

  <div class="print-container" id="printContainer"></div>

  <script>
    // Gi·ªØ nguy√™n AppSheet c·∫•u h√¨nh c·ªßa b·∫°n
    const appId    = '977c97bd-47e4-441c-b564-fe28574e9d74';
    const accessKey= 'V2-sJNk8-IQldL-7uQ80-Iekic-SvMjg-FPH9j-DFCgG-v97aL';
    const region   = 'www'; // v√≠ d·ª•: 'www', 'eu', ...

    const $ = (sel)=>document.querySelector(sel);
    const statusEl = $('#status');
    const printContainer = $('#printContainer');

    // L·∫•y d·ªØ li·ªáu VT_QR t·ª´ AppSheet
    async function fetchVTQR() {
      const url = `https://${region}.appsheet.com/api/v2/apps/${appId}/tables/VT_QR/Action`;
      const body = { Action: 'Find', Properties: {}, Selector: 'Filter(VT_QR, true' };
      const resp = await fetch(url, {
        method: 'POST',
        headers: { 'ApplicationAccessKey': accessKey, 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      const txt = await resp.text();
      if (!resp.ok) throw new Error(`VT_QR HTTP ${resp.status} - ${txt.slice(0,200)}`);
      const data = JSON.parse(txt);
      if (!Array.isArray(data)) throw new Error('D·ªØ li·ªáu tr·∫£ v·ªÅ kh√¥ng ph·∫£i m·∫£ng.');
      return data;
    }

    // L·∫•y gi√° tr·ªã theo nhi·ªÅu t√™n kh√≥a (an to√†n case/c√°ch ƒë·∫∑t c·ªôt)
    function pick(obj, names) {
      for (const n of names) {
        if (obj[n] !== undefined && obj[n] !== null && obj[n] !== '') return obj[n];
        const hit = Object.keys(obj).find(k => k.toLowerCase() === n.toLowerCase());
        if (hit && obj[hit] !== '') return obj[hit];
      }
      return '';
    }

    // T·∫°o URL QR t·ª´ MAHANG
    function qrURL(mahang, size=400) {
      const v = (mahang || '').toString().trim();
      return `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encodeURIComponent(v)}`;
    }

    // Render tem & in
    async function printVTQR_All() {
      statusEl.textContent = 'ƒêang t·∫£i d·ªØ li·ªáu VT_QR...';
      printContainer.innerHTML = '';

      let rows;
      try {
        rows = await fetchVTQR();
      } catch (e) {
        statusEl.textContent = 'L·ªói t·∫£i VT_QR';
        alert('Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c d·ªØ li·ªáu VT_QR:\n' + e.message);
        return;
      }

      if (!rows.length) {
        statusEl.textContent = 'Kh√¥ng c√≥ d·ªØ li·ªáu VT_QR.';
        alert('Kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá trong VT_QR.');
        return;
      }

      statusEl.textContent = 'ƒêang t·∫°o tem...';
      const frag = document.createDocumentFragment();
      let total = 0;

      for (const r of rows) {
        const MAHANG = (pick(r, ['MAHANG','mahang','M√É H√ÄNG']) || '').toString().trim();
        const TENMAU = (pick(r, ['TENMAU','tenmau','T√™n m·∫´u']) || '').toString().trim();
        const SLraw  = pick(r, ['SL','sl','S·ªë l∆∞·ª£ng']);
        const SL = Number.parseInt(SLraw || 1, 10) > 0 ? Number.parseInt(SLraw,10) : 1;

        if (!MAHANG) continue;

        for (let i = 0; i < SL; i++) {
          total++;
          const page = document.createElement('div');
          page.className = 'label';

          page.innerHTML = `
            <div class="qr"><img src="${qrURL(MAHANG)}" alt="QR"></div>
            <div class="text">
              <div class="ma">${MAHANG}</div>
              <div class="ten">${(TENMAU || '').toUpperCase()}</div>
            </div>
          `;
          frag.appendChild(page);
        }
      }

      if (!total) {
        statusEl.textContent = 'Kh√¥ng c√≥ b·∫£n ghi h·ª£p l·ªá.';
        alert('C√≥ d·ªØ li·ªáu nh∆∞ng thi·∫øu c·ªôt MAHANG/SL h·ª£p l·ªá.');
        return;
      }

      printContainer.appendChild(frag);

      // Ch·ªù ·∫£nh QR n·∫°p xong r·ªìi m·ªõi in
      const imgs = printContainer.querySelectorAll('img');
      if (imgs.length) {
        await Promise.all(
          Array.from(imgs).map(img => new Promise(res => {
            if (img.complete) res();
            else { img.onload = res; img.onerror = res; }
          }))
        );
      }

      statusEl.textContent = `ƒê√£ t·∫°o ${total} tem ‚Ä¢ m·ªü h·ªôp tho·∫°i in...`;
      setTimeout(() => { window.print(); statusEl.textContent = 'S·∫µn s√†ng'; }, 120);
    }

    // Event
    document.getElementById('btnPrint').addEventListener('click', printVTQR_All);
  </script>
</body>
</html>
