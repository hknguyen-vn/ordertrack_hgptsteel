<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HGPT Steel - tem QR</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;

            /* 1. ƒê·∫∑t h√¨nh n·ªÅn c·ªßa b·∫°n t·∫°i ƒë√¢y */
            background-image: url('https://images.unsplash.com/photo-1739088033117-15f66e6d2090?q=80&w=2071&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D');
            /* <-- THAY ƒê∆Ø·ªúNG D·∫™N ·∫¢NH C·ª¶A B·∫†N V√ÄO ƒê√ÇY */

            /* 2. T√πy ch·ªânh c√°ch h√¨nh n·ªÅn hi·ªÉn th·ªã */
            background-size: cover;
            /* Ph√≥ng to ·∫£nh ƒë·ªÉ l·∫•p ƒë·∫ßy to√†n b·ªô m√†n h√¨nh */
            background-position: center;
            /* CƒÉn gi·ªØa h√¨nh ·∫£nh */
            background-repeat: no-repeat;
            /* Kh√¥ng l·∫∑p l·∫°i h√¨nh ·∫£nh */
            background-attachment: fixed;
            /* C·ªë ƒë·ªãnh h√¨nh n·ªÅn khi cu·ªôn trang, t·∫°o hi·ªáu ·ª©ng ƒë·∫πp m·∫Øt */
            background-color: #f0f2f5;
            /* M√†u n·ªÅn d·ª± ph√≤ng khi ·∫£nh ƒëang t·∫£i */
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.8);
            /*ƒê·ªô trong su·ªët tr·∫Øng ƒë·ª•c*/
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.35);
            overflow: hidden;
        }

        /* Responsive header and search for mobile */
        @media (max-width: 700px) {
            .header-flex {
                flex-direction: column;
                align-items: stretch;
                padding: 12px 8px;
                gap: 10px;
                border-radius: 0 0 0px 0px;
            }

            .header-title {
                align-items: flex-start;
                text-align: left;
            }

            .search-container {
                min-width: 0;
                max-width: 100%;
                width: 100%;
                margin-top: 6px;
            }

            .search-box {
                font-size: 15px;
                padding: 10px 40px 10px 14px;
            }

            .search-icon {
                right: 12px;
                font-size: 18px;
            }
        }

        .header-flex {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, #cc5302 0%, #fd8300 100%);
            color: white;
            padding: 10px 25px;
            border-radius: 0 0 20px 20px;
            margin-bottom: 10px;
        }

        .header-title {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .header-title h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 0;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .header-title .subtitle {
            font-size: 16px;
            opacity: 0.9;
            font-weight: 300;
        }

        .search-container {
            position: relative;
            max-width: 500px;
            margin: 0 auto;
        }

        .search-box {
            width: 100%;
            padding: 10px 50px 10px 20px;
            border: 3px solid transparent;
            border-radius: 30px;
            font-size: 16px;
            background: white;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: #ff9a56;
            box-shadow: 0 5px 30px rgba(255, 154, 86, 0.3);
        }

        .search-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 20px;
            color: #ff9a56;
        }

        .loading {
            text-align: center;
            padding: 80px 20px;
            color: #6c757d;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #e9ecef;
            border-top: 5px solid #ff9a56;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 30px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @media print {
            #dataContainer {
                display: none !important;
                visibility: hidden !important;
                height: 0 !important;
                overflow: hidden !important;
            }

            .container {
                display: none !important;
            }
        }

        .data-container {
            padding: 10px 25px 25px;
            overflow-y: auto;
        }

        /* ORDER LEVEL - Level 1 */
        .order-item {
            margin-bottom: 20px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
            background: white;
        }

        .order-header {
            background: linear-gradient(135deg, #b97821 0%, #f59f42 50%);
            color: white;
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.3s ease;
        }

        .order-header:hover {
            transform: translateY(-2px);
        }

        .order-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .order-title {
            font-size: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .order-summary {
            font-size: 16px;
            opacity: 0.9;
        }

        .order-actions {
            display: flex;
            align-items: center;
            justify-items: end;
            gap: 15px;
        }

        .print-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .print-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: scale(1.05);
        }

        .print-btn-nhom {
            background: rgba(255, 255, 255, 0.2);
            color: #1976d2;
            border: 2px solid #1976d2;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .print-btn-nhom:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: scale(1.05);
        }

        .expand-icon {
            font-size: 24px;
            transition: transform 0.2s ease;
        }

        .order-item.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .order-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
            background: #f8f9fa;
        }

        .order-item.expanded .order-content {
            max-height: none;
        }

        /* DISPLAY GROUP LEVEL - Level 2 */
        .display-groups-container {
            padding: 15px;
        }

        .display-group {
            margin-bottom: 15px;
            border-radius: 10px;
            overflow: hidden;
            background: white;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.08);
        }

        .display-group-header {
            background: #f5f7fa;
            color: #1976d2;
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }

        .display-group-header:hover {
            transform: translateY(-1px);
        }

        .display-group-info {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .display-group-title {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .display-group-summary {
            font-size: 13px;
            opacity: 0.9;
        }

        .display-group-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: #f1f3f4;
        }

        .display-group.expanded .display-group-content {
            max-height: none;
        }

        /* COMPONENT LEVEL - Level 3 */

        .component-row {
            display: flex;
            align-items: center;
            padding: 8px 14px;
            border-radius: 0;
            box-shadow: none;
            border-bottom: 1px solid #f1f3f4;
            background: #fff;
            margin-bottom: 0;
            font-size: 14px;
            gap: 0;
        }

        .component-row:last-child {
            border-bottom: none;
        }

        .cau-kien-tag {
            background: #28a745;
            color: #fff;
            padding: 2px 10px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 700;
        }

        .components-container {
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .component-card {
            background: white;
            border-radius: 10px;
            padding: 12px 18px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            transition: all 0.2s ease;
            border-left: 4px solid #28a745;
            margin-bottom: 0;
            display: flex;
            align-items: center;
            gap: 15px;
            min-height: 50px;
        }

        .component-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        /* ƒê·ªãnh nghƒ©a layout c√°c c·ªôt */
        .component-checkbox {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .component-column {
            display: flex;
            align-items: center;
            min-height: 20px;
        }

        .component-column.cau-kien-col {
            width: 180px;
            flex-shrink: 0;
        }

        .component-column.ten-sp-col {
            flex: 1;
            min-width: 200px;
            color: #888;
            padding-right: 15px;
        }

        .component-column.weight-col {
            width: 70px;
            flex-shrink: 0;
            font-size: 14px;
            /*c·ªôt kh·ªëi l∆∞·ª£ng*/
            font-weight: 400;
            text-align: right;
        }

        .component-column.qc-col {
            width: 200px;
            flex-shrink: 0;
            font-size: 14px;
            /*c·ªôt quy c√°ch*/
            font-weight: 500;
            color: darkred;
            text-align: right;
        }

        .component-column.quantity-col {
            width: 120px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .component-column.qr-col {
            width: 180px;
            flex-shrink: 0;
            font-size: 10px;
            color: #888;
            text-align: right;
        }

        .sl-input {
            width: 90px !important;
            height: 35px !important;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 5px 8px;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            transition: all 0.2s ease;
        }

        .sl-input:focus {
            outline: none;
            border-color: #ff9a56;
            box-shadow: 0 0 0 3px rgba(255, 154, 86, 0.1);
        }

        .cau-kien-tag {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 700;
            display: inline-block;
        }

        .error {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            padding: 25px;
            margin: 25px;
            border-radius: 15px;
            text-align: center;
        }

        .summary-bar {
            background: linear-gradient(90deg, #4b4b4a 0%, #969592 100%);
            color: white;
            padding: 10px 25px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .summary-item {
            text-align: center;
        }

        .summary-label {
            font-size: 14px;
            font-weight: 700;
            opacity: 0.95;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .summary-value {
            font-size: 18px;
            font-weight: 600;
        }

        /* Print Styles - TEM NGANG 3 TEM/TRANG XOAY -90 ƒê·ªò */
        .print-container {
            display: none;
        }

        /* Print Styles - TEM NGANG v·ªõi n·ªôi dung xoay TR√ÅI 90 ƒë·ªô */
        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
            }

            body {
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
            }

            body * {
                visibility: hidden;
            }

            .print-container,
            .print-container * {
                visibility: visible;
            }

            .print-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100% !important;
                height: 100% !important;
                display: block !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            @page {
                size: 105mm 70mm landscape;
                /* B·ªè landscape, ƒë·ªïi k√≠ch th∆∞·ªõc */
                margin: 0;
            }

            /* Trang in 105x70mm - 3 tem ngang */
            .label-page-horizontal {
                width: 105mm;
                height: 70mm;
                page-break-after: always;
                page-break-before: avoid;
                page-break-inside: avoid;
                margin: 0;
                padding: 0;
                box-sizing: border-box;
                display: flex;
                flex-direction: row;
                font-family: Arial, sans-serif;
                background: white;
            }

            .label-page-horizontal:last-child {
                page-break-after: avoid;
            }

            /* M·ªói tem 35x70mm */
            .label-item-horizontal {
                width: 35mm;
                height: 70mm;
                position: relative;
                border-right: 1px dashed #ccc;
                overflow: hidden;
            }

            .label-item-horizontal:last-child {
                border-right: none;
            }

            /* Container ch√≠nh b√™n trong tem - XOAY TR√ÅI 90 ƒê·ªò */
            .label-item-horizontal .label-wrapper {
                transform: rotate(90deg);
                transform-origin: center center;
                position: absolute;
                width: 70mm;
                /* ƒê·∫£o chi·ªÅu r·ªông cao sau khi xoay */
                height: 35mm;
                left: -17.5mm;
                /* ƒêi·ªÅu ch·ªânh v·ªã tr√≠ ƒë·ªÉ cƒÉn gi·ªØa */
                top: 17.5mm;
                display: flex;
                flex-direction: column;
                padding: 8mm 2mm 2mm 2mm;
                box-sizing: border-box;
            }

            /* === C√ÅC TH√ÄNH PH·∫¶N TH√îNG TIN TR√äN TEM === */

            /* 1. T√™n kh√°ch h√†ng - n·∫±m ·ªü header */
            .label-item-horizontal .label-header {
                width: 80%;
                font-size: 12px;
                font-weight: bold;
                line-height: 1.2;
                color: #000;
                word-wrap: break-word;
                overflow-wrap: break-word;
                margin-bottom: 2mm;
                /* CH√ö TH√çCH: ƒê√¢y l√† v√πng hi·ªÉn th·ªã T√äN KH√ÅCH H√ÄNG (item.ten_kh) */
                /* ƒê·ªÉ th√™m th√¥ng tin m·ªõi v√†o header, s·ª≠a trong h√†m t·∫°o labelItem.innerHTML */
            }

            /* N·ªôi dung ch√≠nh c·ªßa tem - ch·ª©a th√¥ng tin s·∫£n ph·∫©m v√† QR */
            .label-item-horizontal .label-content {
                display: flex;
                flex-direction: row;
                align-items: stretch;
                gap: 1mm;
                flex: 1;
            }

            /* Th√¥ng tin s·∫£n ph·∫©m b√™n tr√°i */
            .label-item-horizontal .label-info {
                flex: 1;
                display: flex;
                flex-direction: column;
                gap: 1mm;
            }

            /* 2. T√™n h·∫°ng m·ª•c LSX */
            .label-item-horizontal .label-info .ten_sp {
                font-size: 10px;
                color: #000;
                word-wrap: break-word;
                line-height: 1.1;
                /* CH√ö TH√çCH: ƒê√¢y l√† T√äN H·∫†NG M·ª§C (item.ten_sp) */
                /* V·ªã tr√≠ hi·ªÉn th·ªã ·ªü ph√≠a tr√™n trong .label-info */
            }

            /* 3. M√£ c·∫•u ki·ªán */
            .label-item-horizontal .label-info .component-name {
                font-size: 12px;
                /* ch·ªânh size ·ªü ƒë√¢y dang l√† 13  */
                font-weight: bold;
                color: #000;
                word-wrap: break-word;
                line-height: 1.3;
                margin-top: 0mm;
                /* CH√ö TH√çCH: ƒê√¢y l√† M√É C·∫§U KI·ªÜN (item.cau_kien) */
                /* Hi·ªÉn th·ªã ·ªü ph√≠a d∆∞·ªõi trong .label-info v·ªõi font ƒë·∫≠m */
            }

            /* CH√ö TH√çCH: V·ªä TR√ç TH√äM TH√îNG TIN M·ªöI */
            /* ƒê·ªÉ th√™m th√¥ng tin m·ªõi v√†o ph·∫ßn .label-info, c√≥ th·ªÉ th√™m div m·ªõi v·ªõi class nh∆∞ .additional-info */

            .label-item-horizontal .label-info .additional-info {
                font-size: 11px;
                color: #000;
                font-weight: bold;
                word-wrap: break-word;
                line-height: 1.2;
                margin-top: 1mm;
            }


            /* Container QR code b√™n ph·∫£i */
            .label-item-horizontal .qr-container {
                width: 17mm;
                margin-right: 2mm;
                display: flex;
                flex-direction: column;
                gap: 1mm;
                /* CH√ö TH√çCH: Container ch·ª©a QR code v√† ID ƒë∆°n h√†ng */
            }

            /* K√≠ch th∆∞·ªõc QR code */
            .label-item-horizontal .qr-container img {
                width: 10mm !important;
                height: 10mm !important;
                max-width: 10mm !important;
                max-height: 10mm !important;
                /* CH√ö TH√çCH: QR Code ƒë∆∞·ª£c t·∫°o t·ª´ item.cau_kien_qr */
            }

            /* ID ƒë∆°n h√†ng d∆∞·ªõi QR code */
            .label-item-horizontal .qr-code-id {
                font-size: 12px;
                color: #000;
                line-height: 1;
                text-align: center;
                /* CH√ö TH√çCH: ƒê√¢y l√† ID CHI TI·∫æT H·∫†NG M·ª§C (item.don_hang_ct_id) */
                /* Hi·ªÉn th·ªã d∆∞·ªõi QR code */
            }

            /* CH√ö TH√çCH: V·ªä TR√ç TH√äM TH√îNG TIN M·ªöI D∆Ø·ªöI QR CODE */
            /* ƒê·ªÉ th√™m th√¥ng tin m·ªõi d∆∞·ªõi QR code, c√≥ th·ªÉ th√™m div v·ªõi class .qr-additional-info */
            /* V√≠ d·ª•:
            .label-item-horizontal .qr-additional-info {
                font-size: 10px;
                color: #666;
                text-align: center;
                margin-top: 1mm;
            }
            */
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-message {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .shift-mode {
            user-select: none;
        }

        .shift-mode .component-checkbox {
            cursor: crosshair !important;
        }

        .component-checkbox:focus {
            outline: 2px solid #3b82f6;
            outline-offset: 1px;
        }

        .drag-selecting {
            background-color: #dbeafe !important;
            border-left-color: #3b82f6 !important;
        }

        .data-container {
            scroll-behavior: smooth;
        }

        .data-container.dragging {
            scroll-behavior: auto;
        }

        .switch-page-btns {
            display: flex;
            gap: 12px;
            margin: 18px 0;
            justify-content: flex-end;
        }

        .switch-page-btns button {
            background: #fff;
            color: #ff9a56;
            border: 0px solid #ffad56;
            border-radius: 18px;
            padding: 9px 28px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(255, 154, 86, 0.12);
            transition: background 0.2s, color 0.2s, box-shadow 0.2s;
        }

        .switch-page-btns button:hover {
            background: #ffad56;
            color: #fff;
            box-shadow: 0 4px 16px rgba(255, 154, 86, 0.22);
        }

        .switch-page-btns button.active,
        .switch-page-btns button:disabled {
            background: #ff9a56;
            color: #fff;
            border: 1px solid #ffad56;
            cursor: default;
            box-shadow: 0 2px 8px rgba(255, 154, 86, 0.12);
            opacity: 1;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header-flex">
            <div class="header-title">
                <h1>HGPT STEEL - QR ORDER</h1>
                <p class="subtitle">In Tem - Tem 3</p>
            </div>
            <div class="search-container">
                <input type="text" class="search-box" id="searchInput" placeholder="T√¨m LSX, C·∫•u ki·ªán, KH...">
                <!-- <span class="search-icon">üîç</span> -->
            </div>
            <div class="switch-page-btns">
                <button
                    onclick="window.location.href='https://hknguyen-vn.github.io/ordertrack_hgptsteel/lsxtem1.html'">In
                    Tem 1</button>
                <button class="active" disabled>In Tem 3</button>
            </div>
        </div>

        <div class="summary-bar" id="summaryBar" style="display: none;">
            <div class="summary-item">
                <div class="summary-label">T·ªïng ƒë∆°n h√†ng</div>
                <div class="summary-value" id="totalOrders">0</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">T·ªïng h·∫°ng m·ª•c</div>
                <div class="summary-value" id="totalDisplayGroups">0</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">T·ªïng c·∫•u ki·ªán</div>
                <div class="summary-value" id="totalComponents">0</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">Kh·ªëi l∆∞·ª£ng</div>
                <div class="summary-value" id="totalWeight">0 kg</div>
            </div>
        </div>

        <div class="loading" id="loadingDiv">
            <div class="loading-spinner"></div>
            <p>ƒêang t·∫£i d·ªØ li·ªáu t·ª´ h·ªá th·ªëng...</p>
        </div>

        <div class="error" id="errorDiv" style="display: none;">
            <h4>‚ö†Ô∏è C√≥ l·ªói x·∫£y ra</h4>
            <p id="errorMessage"></p>
        </div>

        <div class="data-container" id="dataContainer" style="display: none;">
        </div>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-message">
            <div class="loading-spinner"></div>
            <p>ƒêang t·∫°o tem... Vui l√≤ng ƒë·ª£i</p>
        </div>
    </div>

    <div class="print-container" id="printContainer">
    </div>

    <script>
    // Constants
    const appId = '977c97bd-47e4-441c-b564-fe28574e9d74';
    const accessKey = 'V2-sJNk8-IQldL-7uQ80-Iekic-SvMjg-DFCgG-v97aL';
    const region = 'www';

    let allData = [];
    let filteredData = [];
    let groupedData = {};

    let isShiftPressed = false;
    let lastClickedCheckbox = null;
    let isDragging = false;
    let dragStartCheckbox = null;
    let autoScrollTimer = null;

    function generateQRCodeAPI(text, size = 300) {
        if (!text || text.trim() === '') text = 'NO-DATA';
        return `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encodeURIComponent(text)}&charset-source=UTF-8&charset-target=UTF-8`;
    }

    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => { clearTimeout(timeout); func(...args); };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    async function fetchLSXData() {
        const res = await fetch(`https://${region}.appsheet.com/api/v2/apps/${appId}/tables/LSX/Action`, {
            method: 'POST',
            headers: {
                'ApplicationAccessKey': accessKey,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                Action: 'Find',
                Properties: {},
                Selector: "Filter(LSX, true)"
            })
        });

        if (!res.ok) throw new Error("L·ªói t·∫£i d·ªØ li·ªáu m√°y ch·ªß");
        const data = await res.json();
        if (!Array.isArray(data)) throw new Error("Sai ƒë·ªãnh d·∫°ng d·ªØ li·ªáu t·ª´ AppSheet");

        return data;
    }

    function groupDataHierarchically(data) {
        const grouped = {};
        data.forEach(item => {
            const orderId = item.don_hang_id || 'Kh√¥ng c√≥ ƒë∆°n h√†ng';
            const displayGroup = item.hien_thi || 'Kh√¥ng c√≥ nh√≥m hi·ªÉn th·ªã';

            if (!grouped[orderId]) {
                grouped[orderId] = {
                    orderId,
                    customerName: item.ten_kh || '',
                    loai_lenh: item.loai_lenh || '',
                    displayGroups: {},
                    totalWeight: 0,
                    totalComponents: 0,
                    totalDisplayGroups: 0
                };
            }

            if (!grouped[orderId].displayGroups[displayGroup]) {
                grouped[orderId].displayGroups[displayGroup] = {
                    displayName: displayGroup,
                    components: [],
                    totalWeight: 0,
                    componentCount: 0
                };
                grouped[orderId].totalDisplayGroups++;
            }

            grouped[orderId].displayGroups[displayGroup].components.push(item);

            if (item.cau_kien && item.cau_kien.trim() !== '') {
                grouped[orderId].displayGroups[displayGroup].componentCount++;
                grouped[orderId].totalComponents++;
            }

            const weight = parseFloat(item.khoi_luong) || 0;
            grouped[orderId].displayGroups[displayGroup].totalWeight += weight;
            grouped[orderId].totalWeight += weight;
        });
        return grouped;
    }

    function formatNumber(value) {
        if (value === null || value === undefined || value === '') return '0';
        const num = parseFloat(value);
        if (isNaN(num)) return '0';
        return num.toLocaleString('vi-VN');
    }

    // ==========================
    // HI·ªÇN TH·ªä COMPONENT
    // ==========================
    function createComponentCardHTML(component, idx, orderId, displayGroupName) {
        const safeId = `ck_${orderId}_${displayGroupName}_${idx}`;

        return `
        <div class="component-card component-row">
            <input type="checkbox" class="component-checkbox" id="${safeId}"
                data-order-id="${orderId}" 
                data-group-name="${displayGroupName}" 
                data-idx="${idx}"
                checked
                onchange="handleCheckboxChange(this)"
                onmousedown="handleMouseDown(this, event)"
                onmouseenter="handleMouseEnter(this, event)">
            
            <div class="component-column cau-kien-col">
                <span class="cau-kien-tag">${component.cau_kien || ''}</span>
            </div>
            
            <div class="component-column quantity-col">
                <span>SL:</span>
                <input 
                    type="number" 
                    min="0" 
                    value="${component.sl_san_xuat || 1}" 
                    class="sl-input" 
                    data-idx="${idx}"
                    oninput="handleQuantityChange(this)" />
            </div>
            
            <div class="component-column weight-col">
                <span>${component.khoi_luong || ''} kg</span>
            </div>

            <div class="component-column qc-col">
                <span>${component.quy_cach || ''}</span>
            </div>

            <div class="component-column ten-sp-col">
                <span>${component.ten_sp || ''}</span>
            </div>
            
            <div class="component-column qr-col">
                <span>QR: ${component.cau_kien_qr || ''}</span>
            </div>
        </div>
        `;
    }

    function generateSafeId(text) {
        return text.replace(/[^a-zA-Z0-9]/g, '_');
    }

    function renderHierarchicalData(data) {
        const container = document.getElementById('dataContainer');
        container.innerHTML = '';

        if (Object.keys(data).length === 0) {
            container.innerHTML = `<div style="padding:40px;text-align:center;color:#777">Kh√¥ng c√≥ d·ªØ li·ªáu</div>`;
            return;
        }

        Object.values(data).forEach(order => {
            const safeOrderId = generateSafeId(order.orderId);

            const orderElement = document.createElement('div');
            orderElement.className = 'order-item';
            orderElement.id = `order-${safeOrderId}`;

            orderElement.innerHTML = `
                <div class="order-header" onclick="toggleOrderExpansion('${safeOrderId}')">
                    <div class="order-info">
                        <div class="order-title">
                            <span>üìã</span>
                            <span>${order.orderId} - ${order.loai_lenh}</span>
                        </div>
                        <div class="order-summary">
                            ${order.customerName} ‚Ä¢ 
                            ${order.totalDisplayGroups} h·∫°ng m·ª•c ‚Ä¢
                            ${order.totalComponents} c·∫•u ki·ªán ‚Ä¢
                            ${formatNumber(order.totalWeight)} kg
                        </div>
                    </div>

                    <div class="order-actions">
                        <button class="print-btn" onclick="printOrderLabelsHorizontal('${order.orderId}', event)">
                            üñ®Ô∏è In Tem 3
                        </button>
                        <span class="expand-icon">‚ñº</span>
                    </div>
                </div>

                <div class="order-content">
                    <div class="display-groups-container" data-order-id="${order.orderId}">
                    </div>
                </div>
            `;

            container.appendChild(orderElement);
        });
    }

    function loadDisplayGroups(orderId) {
        const order = groupedData[orderId];
        if (!order) return;

        const container = document.querySelector(`[data-order-id="${orderId}"]`);
        container.innerHTML = '';

        const sortedGroups = Object.values(order.displayGroups);

        sortedGroups.forEach(displayGroup => {
            const displayElement = document.createElement('div');
            displayElement.className = 'display-group';

            displayElement.innerHTML = `
                <div class="display-group-header" onclick="toggleDisplayGroupExpansion('${orderId}', '${displayGroup.displayName}')">
                    <label onclick="event.stopPropagation();toggleSelectAllInGroup('${orderId}','${displayGroup.displayName}',this)">
                        <input type="checkbox">
                    </label>

                    <div class="display-group-info">
                        <div class="display-group-title">
                            üìÅ ${displayGroup.displayName}
                        </div>
                        <div class="display-group-summary">
                            ${displayGroup.componentCount} c·∫•u ki·ªán ‚Ä¢ 
                            ${formatNumber(displayGroup.totalWeight)} kg
                        </div>
                    </div>

                    <div class="order-actions">
                        <button class="print-btn-nhom"
                            onclick="printCheckedComponentsHorizontal('${orderId}', '${displayGroup.displayName}', event)">
                            üñ®Ô∏è In Tem 3
                        </button>
                        <span class="expand-icon">‚ñº</span>
                    </div>
                </div>

                <div class="display-group-content">
                    <div class="components-container" data-display-group="${orderId}|||${displayGroup.displayName}">
                    </div>
                </div>
            `;

            container.appendChild(displayElement);
        });
    }

    function loadComponents(orderId, displayGroupName) {
        const order = groupedData[orderId];
        if (!order) return;

        const group = order.displayGroups[displayGroupName];
        if (!group) return;

        const container = document.querySelector(`[data-display-group="${orderId}|||${displayGroupName}"]`);
        container.innerHTML = '';

        group.components.forEach((component, idx) => {
            const div = document.createElement('div');
            div.innerHTML = createComponentCardHTML(component, idx, orderId, displayGroupName);
            container.appendChild(div.firstElementChild);
        });

        updateSelectedWeightSummary();  // c·∫≠p nh·∫≠t t·ªïng ngay khi m·ªü nh√≥m
    }

    function toggleOrderExpansion(safeId) {
        const orderEl = document.getElementById(`order-${safeId}`);
        if (!orderEl) return;

        if (orderEl.classList.contains('expanded')) {
            orderEl.classList.remove('expanded');
        } else {
            orderEl.classList.add('expanded');

            const originId = Object.keys(groupedData).find(id => generateSafeId(id) === safeId);
            loadDisplayGroups(originId);
        }
    }

    function toggleDisplayGroupExpansion(orderId, groupName) {
        const container = document.querySelector(`[data-display-group="${orderId}|||${groupName}"]`);
        const wrapper = container.closest('.display-group');

        if (wrapper.classList.contains('expanded')) {
            wrapper.classList.remove('expanded');
            container.innerHTML = '';
        } else {
            wrapper.classList.add('expanded');
            loadComponents(orderId, groupName);
        }
    }

    // ==============================
    // H√ÄM T√çNH T·ªîNG KL ƒê√É CH·ªåN
    // ==============================
    function updateSelectedWeightSummary() {
        let totalSelected = 0;

        const rows = document.querySelectorAll('.component-row');
        rows.forEach(row => {
            const checkbox = row.querySelector('.component-checkbox');
            if (!checkbox || !checkbox.checked) return;

            const weightSpan = row.querySelector('.weight-col span');
            if (!weightSpan) return;

            let text = weightSpan.textContent.replace(/kg/i, '').trim();
            const weightPerItem = parseFloat(text.replace(/\./g, '').replace(',', '.')) || 0;

            const qtyInput = row.querySelector('.sl-input');
            let qty = qtyInput ? parseInt(qtyInput.value) : 1;
            if (isNaN(qty) || qty < 0) qty = 0;

            totalSelected += weightPerItem * qty;
        });

        const el = document.getElementById('selectedWeight');
        if (el) el.textContent = formatNumber(totalSelected) + ' kg';
    }

    function handleQuantityChange(input) {
        let v = parseInt(input.value);
        if (isNaN(v) || v < 0) v = 0;
        input.value = v;
        updateSelectedWeightSummary();
    }

    // ==============================
    // TICK / SHIFT / DRAG SELECT
    // ==============================
    function handleCheckboxChange(checkbox) {
        if (isShiftPressed && lastClickedCheckbox) {
            handleRangeSelection(checkbox);
        } else {
            lastClickedCheckbox = checkbox;
        }
        updateSelectedWeightSummary();
    }

    function toggleSelectAllInGroup(orderId, groupName, label) {
        const isChecked = label.querySelector("input").checked;
        const container = document.querySelector(`[data-display-group="${orderId}|||${groupName}"]`);
        if (!container) return;

        container.querySelectorAll(".component-checkbox").forEach(cb => cb.checked = isChecked);

        updateSelectedWeightSummary();
    }

    function handleRangeSelection(currentCheckbox) {
        const container = currentCheckbox.closest('.components-container');
        if (!container) return;

        const all = Array.from(container.querySelectorAll('.component-checkbox'));
        const start = all.indexOf(lastClickedCheckbox);
        const end = all.indexOf(currentCheckbox);

        if (start >= 0 && end >= 0) {
            const min = Math.min(start, end);
            const max = Math.max(start, end);
            for (let i = min; i <= max; i++) all[i].checked = currentCheckbox.checked;
        }

        updateSelectedWeightSummary();
    }

    function handleMouseDown(checkbox, event) {
        if (isShiftPressed) {
            event.preventDefault();
            isDragging = true;
            dragStartCheckbox = checkbox;

            const container = checkbox.closest('.components-container');
            const boxes = Array.from(container.querySelectorAll('.component-checkbox'));
            window.dragOriginalStates = boxes.map(cb => cb.checked);

            checkbox.checked = true;
        } else {
            lastClickedCheckbox = checkbox;
        }
    }

    function handleMouseEnter(checkbox, event) {
        if (!isDragging || !isShiftPressed) return;

        const container = checkbox.closest('.components-container');
        const all = Array.from(container.querySelectorAll('.component-checkbox'));

        const start = all.indexOf(dragStartCheckbox);
        const end = all.indexOf(checkbox);
        if (start < 0 || end < 0) return;

        all.forEach((cb, idx) => cb.checked = window.dragOriginalStates[idx]);

        const min = Math.min(start, end);
        const max = Math.max(start, end);
        for (let i = min; i <= max; i++) all[i].checked = true;

        updateSelectedWeightSummary();
    }

    document.addEventListener("mouseup", () => {
        isDragging = false;
        dragStartCheckbox = null;
        window.dragOriginalStates = null;
    });

    document.addEventListener("keydown", e => {
        if (e.key === "Shift") isShiftPressed = true;
    });

    document.addEventListener("keyup", e => {
        if (e.key === "Shift") {
            isShiftPressed = false;
            isDragging = false;
        }
    });

    // ==============================
    // SUMMARY
    // ==============================
    function updateSummary(data) {
        let totalOrders = Object.keys(data).length;
        let totalGroups = 0;
        let totalComponents = 0;
        let totalWeight = 0;

        Object.values(data).forEach(order => {
            totalGroups += order.totalDisplayGroups;
            totalComponents += order.totalComponents;
            totalWeight += order.totalWeight;
        });

        document.getElementById('totalOrders').textContent = formatNumber(totalOrders);
        document.getElementById('totalDisplayGroups').textContent = formatNumber(totalGroups);
        document.getElementById('totalComponents').textContent = formatNumber(totalComponents);
        document.getElementById('totalWeight').textContent = formatNumber(totalWeight) + ' kg';

        document.getElementById('summaryBar').style.display = 'flex';
    }

    const debouncedFilter = debounce(term => {
        if (!term.trim()) {
            filteredData = allData;
        } else {
            const t = term.toLowerCase();
            filteredData = allData.filter(item =>
                (item.don_hang_id && item.don_hang_id.toLowerCase().includes(t)) ||
                (item.ten_kh && item.ten_kh.toLowerCase().includes(t)) ||
                (item.ten_sp && item.ten_sp.toLowerCase().includes(t)) ||
                (item.cau_kien && item.cau_kien.toLowerCase().includes(t)) ||
                (item.hien_thi && item.hien_thi.toLowerCase().includes(t))
            );
        }

        groupedData = groupDataHierarchically(filteredData);
        renderHierarchicalData(groupedData);
        updateSummary(groupedData);
    }, 300);

    // ==============================
    // KH·ªûI T·∫†O
    // ==============================
    async function initialize() {
        try {
            let data = await fetchLSXData();

            data = data.filter(item =>
                item.khoi_luong_dv &&
                item.cau_kien_qr &&
                item.khoi_luong_dv !== "#DIV/0!" &&
                item.cau_kien_qr !== "#DIV/0!"
            );

            allData = data;
            filteredData = data;

            groupedData = groupDataHierarchically(filteredData);
            renderHierarchicalData(groupedData);
            updateSummary(groupedData);

            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('dataContainer').style.display = 'block';

        } catch (e) {
            console.error(e);
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('errorDiv').style.display = 'block';
            document.getElementById('errorMessage').textContent = e.message;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('searchInput').addEventListener('input', function () {
            debouncedFilter(this.value);
        });
        initialize();
    });

    // Export Global
    window.handleCheckboxChange = handleCheckboxChange;
    window.handleMouseDown = handleMouseDown;
    window.handleMouseEnter = handleMouseEnter;
    window.toggleSelectAllInGroup = toggleSelectAllInGroup;
    window.updateSelectedWeightSummary = updateSelectedWeightSummary;
    window.handleQuantityChange = handleQuantityChange;
</script>

</body>

</html>