<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HGPT Steel - tem QR</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            
            /* 1. Đặt hình nền của bạn tại đây */
            background-image: url('https://images.unsplash.com/photo-1655320999496-79baedfc90be?q=80&w=1170&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'); /* <-- THAY ĐƯỜNG DẪN ẢNH CỦA BẠN VÀO ĐÂY */

            /* 2. Tùy chỉnh cách hình nền hiển thị */
            background-size: cover;          /* Phóng to ảnh để lấp đầy toàn bộ màn hình */
            background-position: center;     /* Căn giữa hình ảnh */
            background-repeat: no-repeat;    /* Không lặp lại hình ảnh */
            background-attachment: fixed;    /* Cố định hình nền khi cuộn trang, tạo hiệu ứng đẹp mắt */
            background-color: #f0f2f5;       /* Màu nền dự phòng khi ảnh đang tải */
                }

                .container {
                    max-width: 1400px;
                    margin: 0 auto;
                    background: rgba(255, 255, 255, 0.95);
                    border-radius: 20px;
                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
                    overflow: hidden;
        }

        /* Responsive header and search for mobile */
        @media (max-width: 700px) {
            .header-flex {
                flex-direction: column;
                align-items: stretch;
                padding: 12px 8px;
                gap: 10px;
                border-radius: 0 0 0px 0px;
            }

            .header-title {
                align-items: flex-start;
                text-align: left;
            }

            .search-container {
                min-width: 0;
                max-width: 100%;
                width: 100%;
                margin-top: 6px;
            }

            .search-box {
                font-size: 15px;
                padding: 10px 40px 10px 14px;
            }

            .search-icon {
                right: 12px;
                font-size: 18px;
            }
        }

        .header-flex {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, #cc5302 0%, #fd8300 100%);
            color: white;
            padding: 10px 25px;
            border-radius: 0 0 20px 20px;
            margin-bottom: 10px;
        }

        .header-title {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .header-title h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 0;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .header-title .subtitle {
            font-size: 16px;
            opacity: 0.9;
            font-weight: 300;
        }

        .search-container {
            position: relative;
            max-width: 500px;
            margin: 0 auto;
        }

        .search-box {
            width: 100%;
            padding: 10px 50px 10px 20px;
            border: 3px solid transparent;
            border-radius: 30px;
            font-size: 16px;
            background: white;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: #ff9a56;
            box-shadow: 0 5px 30px rgba(255, 154, 86, 0.3);
        }

        .search-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 20px;
            color: #ff9a56;
        }

        .loading {
            text-align: center;
            padding: 80px 20px;
            color: #6c757d;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #e9ecef;
            border-top: 5px solid #ff9a56;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 30px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @media print {
            #dataContainer {
                display: none !important;
                visibility: hidden !important;
                height: 0 !important;
                overflow: hidden !important;
            }

            .container {
                display: none !important;
            }
        }

        .data-container {
            padding: 10px 25px 25px;
            overflow-y: auto;
        }

        /* ORDER LEVEL - Level 1 */
        .order-item {
            margin-bottom: 20px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
            background: white;
        }

        .order-header {
            background: linear-gradient(135deg, #eea84e 0%, #f7be81 100%);
            color: white;
            padding: 10px 25px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.2s ease;
        }

        .order-header:hover {
            transform: translateY(-2px);
        }

        .order-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .order-title {
            font-size: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .order-summary {
            font-size: 14px;
            opacity: 0.9;
        }

        .order-actions {
            display: flex;
            align-items: center;
            justify-items: end;
            gap: 15px;
        }

        .print-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .print-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: scale(1.05);
        }

        .print-btn-nhom {
            background: rgba(255, 255, 255, 0.2);
            color: #1976d2;
            border: 2px solid #1976d2;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .print-btn-nhom:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: scale(1.05);
        }

        .expand-icon {
            font-size: 24px;
            transition: transform 0.2s ease;
        }

        .order-item.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .order-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
            background: #f8f9fa;
        }

        .order-item.expanded .order-content {
            max-height: none;
        }

        /* DISPLAY GROUP LEVEL - Level 2 */
        .display-groups-container {
            padding: 15px;
        }

        .display-group {
            margin-bottom: 15px;
            border-radius: 10px;
            overflow: hidden;
            background: white;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.08);
        }

        .display-group-header {
            background: #f5f7fa;
            color: #1976d2;
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }

        .display-group-header:hover {
            transform: translateY(-1px);
        }

        .display-group-info {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .display-group-title {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items:stretch;
            gap: 8px;
        }

        .display-group-summary {
            font-size: 13px;
            opacity: 0.9;
        }

        .display-group-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: #f1f3f4;
        }

        .display-group.expanded .display-group-content {
            max-height: none;
        }

        /* COMPONENT LEVEL - Level 3 */

        .component-row {
            display: flex;
            align-items: center;
            padding: 8px 14px;
            border-radius: 0;
            box-shadow: none;
            border-bottom: 1px solid #f1f3f4;
            background: #fff;
            margin-bottom: 0;
            font-size: 14px;
            gap: 0;
        }

        .component-row:last-child {
            border-bottom: none;
        }

        .cau-kien-tag {
            background: #28a745;
            color: #fff;
            padding: 2px 10px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 700;
        }

        .components-container {
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .component-card {
            background: white;
            border-radius: 10px;
            padding: 12px 18px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            transition: all 0.2s ease;
            border-left: 4px solid #28a745;
            margin-bottom: 0;
            display: flex;
            align-items: center;
            gap: 15px;
            min-height: 50px;
        }

        .component-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        /* Định nghĩa layout các cột */
        .component-checkbox {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .component-column {
            display: flex;
            align-items: center;
            min-height: 20px;
        }

        .component-column.cau-kien-col {
            width: 180px;
            flex-shrink: 0;
        }

        .component-column.ten-sp-col {
            flex: 1;
            min-width: 200px;
            color: #888;
            padding-right: 15px;
        }

        .component-column.weight-col {
            width: 50px; 
            flex-shrink: 0;
            font-size: 14px; /*cột khối lượng*/
            font-weight: 400;
            text-align: right;
        }

        .component-column.qc-col {
            width: 200px;
            flex-shrink: 0;
            font-size: 14px; /*cột quy cách*/
            font-weight: 500;
            color:darkred;
            text-align: right;
        }

        .component-column.quantity-col {
            width: 120px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .component-column.qr-col {
            width: 180px;
            flex-shrink: 0;
            font-size: 10px;
            color: #888;
            text-align: right;
        }

        .sl-input {
            width: 90px !important;
            height: 35px !important;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 5px 8px;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            transition: all 0.2s ease;
        }

        .sl-input:focus {
            outline: none;
            border-color: #ff9a56;
            box-shadow: 0 0 0 3px rgba(255, 154, 86, 0.1);
        }

        .cau-kien-tag {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 700;
            display: inline-block;
        }

        .error {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            padding: 25px;
            margin: 25px;
            border-radius: 15px;
            text-align: center;
        }

        .summary-bar {
            background: linear-gradient(135deg, #cfb313 0%, #c5b101 100%);
            color: white;
            padding: 10px 25px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .summary-item {
            text-align: center;
        }

        .summary-label {
            font-size: 14px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .summary-value {
            font-size: 18px;
            font-weight: 600;
        }

        /* Print Styles - TEM NGANG 3 TEM/TRANG XOAY -90 ĐỘ */
        .print-container {
            display: none;
        }

        /* Print Styles - TEM NGANG với nội dung xoay TRÁI 90 độ */
        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
            }

            body {
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
            }

            body * {
                visibility: hidden;
            }

            .print-container,
            .print-container * {
                visibility: visible;
            }

            .print-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100% !important;
                height: 100% !important;
                display: block !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            @page {
                size: 105mm 70mm landscape;
                /* Bỏ landscape, đổi kích thước */
                margin: 0;
            }

            /* Trang in 105x70mm - 3 tem ngang */
            .label-page-horizontal {
                width: 105mm;
                height: 70mm;
                page-break-after: always;
                page-break-before: avoid;
                page-break-inside: avoid;
                margin: 0;
                padding: 0;
                box-sizing: border-box;
                display: flex;
                flex-direction: row;
                font-family: Arial, sans-serif;
                background: white;
            }

            .label-page-horizontal:last-child {
                page-break-after: avoid;
            }

            /* Mỗi tem 35x70mm */
            .label-item-horizontal {
                width: 35mm;
                height: 70mm;
                position: relative;
                border-right: 1px dashed #ccc;
                overflow: hidden;
            }

            .label-item-horizontal:last-child {
                border-right: none;
            }

            /* Container chính bên trong tem - XOAY TRÁI 90 ĐỘ */
            .label-item-horizontal .label-wrapper {
                transform: rotate(90deg);
                transform-origin: center center;
                position: absolute;
                width: 70mm;
                /* Đảo chiều rộng cao sau khi xoay */
                height: 35mm;
                left: -17.5mm;
                /* Điều chỉnh vị trí để căn giữa */
                top: 17.5mm;
                display: flex;
                flex-direction: column;
                padding: 8mm 2mm 2mm 2mm;
                box-sizing: border-box;
            }

            /* === CÁC THÀNH PHẦN THÔNG TIN TRÊN TEM === */

            /* 1. Tên khách hàng - nằm ở header */
            .label-item-horizontal .label-header {
                width: 80%;
                font-size: 13px;
                font-weight: bold;
                line-height: 1.2;
                color: #000;
                word-wrap: break-word;
                overflow-wrap: break-word;
                margin-bottom: 2mm;
                /* CHÚ THÍCH: Đây là vùng hiển thị TÊN KHÁCH HÀNG (item.ten_kh) */
                /* Để thêm thông tin mới vào header, sửa trong hàm tạo labelItem.innerHTML */
            }

            /* Nội dung chính của tem - chứa thông tin sản phẩm và QR */
            .label-item-horizontal .label-content {
                display: flex;
                flex-direction: row;
                align-items: stretch;
                gap: 1mm;
                flex: 1;
            }

            /* Thông tin sản phẩm bên trái */
            .label-item-horizontal .label-info {
                flex: 1;
                display: flex;
                flex-direction: column;
                gap: 1mm;
            }

            /* 2. Tên hạng mục LSX */
            .label-item-horizontal .label-info .ten_sp {
                font-size: 12px;
                color: #000;
                word-wrap: break-word;
                line-height: 1.1;
                /* CHÚ THÍCH: Đây là TÊN HẠNG MỤC (item.ten_sp) */
                /* Vị trí hiển thị ở phía trên trong .label-info */
            }

            /* 3. Mã cấu kiện */
            .label-item-horizontal .label-info .component-name {
                font-size: 13px;  /* chỉnh size ở đây dang là 13  */
                font-weight: bold;
                color: #000;
                word-wrap: break-word;
                line-height: 1.3;
                margin-top: 0mm;
                /* CHÚ THÍCH: Đây là MÃ CẤU KIỆN (item.cau_kien) */
                /* Hiển thị ở phía dưới trong .label-info với font đậm */
            }

            /* CHÚ THÍCH: VỊ TRÍ THÊM THÔNG TIN MỚI */
            /* Để thêm thông tin mới vào phần .label-info, có thể thêm div mới với class như .additional-info */
           
            .label-item-horizontal .label-info .additional-info {
                font-size: 11px;
                color: #000;
                font-weight: bold;
                word-wrap: break-word;
                line-height: 1.2;
                margin-top: 1mm;
            }
            

            /* Container QR code bên phải */
            .label-item-horizontal .qr-container {
                width: 17mm;
                margin-right: 2mm;
                display: flex;
                flex-direction: column;
                gap: 1mm;
                /* CHÚ THÍCH: Container chứa QR code và ID đơn hàng */
            }

            /* Kích thước QR code */
            .label-item-horizontal .qr-container img {
                width: 10mm !important;
                height: 10mm !important;
                max-width: 10mm !important;
                max-height: 10mm !important;
                /* CHÚ THÍCH: QR Code được tạo từ item.cau_kien_qr */
            }

            /* ID đơn hàng dưới QR code */
            .label-item-horizontal .qr-code-id {
                font-size: 12px;
                color: #000;
                line-height: 1;
                text-align: center;
                /* CHÚ THÍCH: Đây là ID CHI TIẾT HẠNG MỤC (item.don_hang_ct_id) */
                /* Hiển thị dưới QR code */
            }

            /* CHÚ THÍCH: VỊ TRÍ THÊM THÔNG TIN MỚI DƯỚI QR CODE */
            /* Để thêm thông tin mới dưới QR code, có thể thêm div với class .qr-additional-info */
            /* Ví dụ:
            .label-item-horizontal .qr-additional-info {
                font-size: 10px;
                color: #666;
                text-align: center;
                margin-top: 1mm;
            }
            */
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-message {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .shift-mode {
            user-select: none;
        }

        .shift-mode .component-checkbox {
            cursor: crosshair !important;
        }

        .component-checkbox:focus {
            outline: 2px solid #3b82f6;
            outline-offset: 1px;
        }

        .drag-selecting {
            background-color: #dbeafe !important;
            border-left-color: #3b82f6 !important;
        }

        .data-container {
            scroll-behavior: smooth;
        }

        .data-container.dragging {
            scroll-behavior: auto;
        }

        .switch-page-btns {
            display: flex;
            gap: 12px;
            margin: 18px 0;
            justify-content: flex-end;
        }

        .switch-page-btns button {
            background: #fff;
            color: #ff9a56;
            border: 0px solid #ffad56;
            border-radius: 18px;
            padding: 9px 28px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(255, 154, 86, 0.12);
            transition: background 0.2s, color 0.2s, box-shadow 0.2s;
        }

        .switch-page-btns button:hover {
            background: #ffad56;
            color: #fff;
            box-shadow: 0 4px 16px rgba(255, 154, 86, 0.22);
        }

        .switch-page-btns button.active,
        .switch-page-btns button:disabled {
            background: #ff9a56;
            color: #fff;
            border: 1px solid #ffad56;
            cursor: default;
            box-shadow: 0 2px 8px rgba(255, 154, 86, 0.12);
            opacity: 1;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header-flex">
            <div class="header-title">
                <h1>HGPT STEEL - QR ORDER</h1>
                <p class="subtitle">In Tem - Tem 3</p>
            </div>
            <div class="search-container">
                <input type="text" class="search-box" id="searchInput"
                    placeholder="Tìm LSX, Cấu kiện, KH...">
                <span class="search-icon">🔍</span>
            </div>
            <div class="switch-page-btns">
                <button onclick="window.location.href='https://hknguyen-vn.github.io/ordertrack_hgptsteel/lsxtem1.html'">In Tem 1</button>
                <button class="active" disabled>In Tem 3</button>
            </div>
        </div>

        <div class="summary-bar" id="summaryBar" style="display: none;">
            <div class="summary-item">
                <div class="summary-label">Tổng đơn hàng</div>
                <div class="summary-value" id="totalOrders">0</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">Tổng hạng mục</div>
                <div class="summary-value" id="totalDisplayGroups">0</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">Tổng cấu kiện</div>
                <div class="summary-value" id="totalComponents">0</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">Khối lượng</div>
                <div class="summary-value" id="totalWeight">0 kg</div>
            </div>
        </div>

        <div class="loading" id="loadingDiv">
            <div class="loading-spinner"></div>
            <p>Đang tải dữ liệu từ hệ thống...</p>
        </div>

        <div class="error" id="errorDiv" style="display: none;">
            <h4>⚠️ Có lỗi xảy ra</h4>
            <p id="errorMessage"></p>
        </div>

        <div class="data-container" id="dataContainer" style="display: none;">
        </div>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-message">
            <div class="loading-spinner"></div>
            <p>Đang tạo tem... Vui lòng đợi</p>
        </div>
    </div>

    <div class="print-container" id="printContainer">
    </div>

    <script>
        // Constants
        const appId = '977c97bd-47e4-441c-b564-fe28574e9d74';
        const accessKey = 'V2-sJNk8-IQldL-7uQ80-Iekic-SvMjg-FPH9j-DFCgG-v97aL';
        const region = 'www';

        let allData = [];
        let filteredData = [];
        let groupedData = {};

        let isShiftPressed = false;
        let lastClickedCheckbox = null;
        let isDragging = false;
        let dragStartCheckbox = null;
        let autoScrollTimer = null;

        function generateQRCodeAPI(text, size = 300) {
            if (!text || text.trim() === '') text = 'NO-DATA';
            return `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encodeURIComponent(text)}&charset-source=UTF-8&charset-target=UTF-8`;
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => { clearTimeout(timeout); func(...args); };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        async function fetchLSXData() {
            try {
                const response = await fetch(`https://${region}.appsheet.com/api/v2/apps/${appId}/tables/LSX/Action`, {
                    method: 'POST',
                    headers: {
                        'ApplicationAccessKey': accessKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        Action: 'Find',
                        Properties: {},
                        Selector: "Filter(LSX, true)"
                    })
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                if (!Array.isArray(data)) throw new Error('Invalid data format received');
                return data;
            } catch (error) {
                console.error('Failed to fetch LSX data:', error);
                throw error;
            }
        }

        function groupDataHierarchically(data) {
            const grouped = {};

            data.forEach(item => {
                const orderId = item.don_hang_id || 'Không có đơn hàng';
                const displayGroup = item.hien_thi || 'Không có nhóm hiển thị';

                if (!grouped[orderId]) {
                    grouped[orderId] = {
                        orderId: orderId,
                        customerName: item.ten_kh || '',
                        displayGroups: {},
                        totalWeight: 0,
                        totalComponents: 0,
                        totalDisplayGroups: 0
                    };
                }

                if (!grouped[orderId].displayGroups[displayGroup]) {
                    grouped[orderId].displayGroups[displayGroup] = {
                        displayName: displayGroup,
                        components: [],
                        totalWeight: 0,
                        componentCount: 0
                    };
                    grouped[orderId].totalDisplayGroups += 1;
                }

                grouped[orderId].displayGroups[displayGroup].components.push(item);

                if (item.cau_kien && item.cau_kien.trim() !== '') {
                    grouped[orderId].displayGroups[displayGroup].componentCount += 1;
                    grouped[orderId].totalComponents += 1;
                }

                const weight = parseFloat(item.khoi_luong) || 0;
                grouped[orderId].displayGroups[displayGroup].totalWeight += weight;
                grouped[orderId].totalWeight += weight;
            });

            return grouped;
        }

        function formatNumber(value) {
            if (value === null || value === undefined || value === '') return '0';
            const num = parseFloat(value);
            if (isNaN(num)) return '0';
            return num.toLocaleString('vi-VN');
        }

        // CHÚ THÍCH: Hàm tạo HTML cho component card trong danh sách
        // Đây là nơi hiển thị thông tin component trên giao diện chính
        function createComponentCardHTML(component, idx, orderId, displayGroupName) {
            const safeId = `ck_${orderId}_${displayGroupName}_${idx}`;
            return `
        <div class="component-card component-row">
            <input type="checkbox" class="component-checkbox" id="${safeId}" 
                data-order-id="${orderId}" data-group-name="${displayGroupName}" data-idx="${idx}" checked
                onchange="handleCheckboxChange(this)"
                onmousedown="handleMouseDown(this, event)"
                onmouseenter="handleMouseEnter(this, event)">
            
            <div class="component-column cau-kien-col">
                <span class="cau-kien-tag">${component.cau_kien || ''}</span>
            </div>
            
            <div class="component-column quantity-col">
                <span>SL:</span>
                <input type="number" min="1" value="${component.sl_san_xuat || 1}" 
                    class="sl-input" data-idx="${idx}" />
            </div>
            
            <div class="component-column weight-col">
                <span>${component.khoi_luong || ''} kg</span>
            </div>

            <div class="component-column qc-col">
                <span>${component.quy_cach || ''}</span>
            </div>

            <div class="component-column ten-sp-col">
                <span>${component.ten_sp || ''}</span>
            </div>
            
            <div class="component-column qr-col">
                <span>QR: ${component.cau_kien_qr || ''}</span>
            </div>
        </div>
    `;
        }

        function generateSafeId(text) {
            return text.replace(/[^a-zA-Z0-9]/g, '_');
        }

        function renderHierarchicalData(data) {
            const container = document.getElementById('dataContainer');
            container.innerHTML = '';

            if (Object.keys(data).length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 50px; color: #666;">Không có dữ liệu để hiển thị</div>';
                return;
            }

            Object.values(data).forEach(order => {
                const safeOrderId = generateSafeId(order.orderId);
                const orderElement = document.createElement('div');
                orderElement.className = 'order-item';
                orderElement.id = `order-${safeOrderId}`;

                const displayGroupCount = Object.keys(order.displayGroups).length;
                orderElement.innerHTML = `
                    <div class="order-header" onclick="toggleOrderExpansion('${safeOrderId}')">
                        <div class="order-info">
                            <div class="order-title">
                                <span>📋</span>
                                <span>${order.orderId}</span>
                            </div>
                            <div class="order-summary">
                                ${order.customerName} • ${displayGroupCount} hạng mục • 
                                ${order.totalComponents} cấu kiện • ${formatNumber(order.totalWeight)} kg
                            </div>
                        </div>
                        <div class="order-actions">
                            <button class="print-btn" onclick="printOrderLabelsHorizontal('${order.orderId}', event)">
                                🖨️ In Tem 3
                            </button>
                            <span class="expand-icon">▼</span>
                        </div>
                    </div>
                    <div class="order-content">
                        <div class="display-groups-container" data-order-id="${order.orderId}">
                        </div>
                    </div>
                `;

                container.appendChild(orderElement);
            });
        }

        function loadDisplayGroups(orderId) {
            const order = groupedData[orderId];
            if (!order) return;

            const container = document.querySelector(`[data-order-id="${orderId}"]`);
            if (!container) return;

            container.innerHTML = '';

            Object.values(order.displayGroups).forEach(displayGroup => {
                const safeDisplayName = generateSafeId(displayGroup.displayName);
                const safeOrderId = generateSafeId(orderId);

                const displayElement = document.createElement('div');
                displayElement.className = 'display-group';

                displayElement.innerHTML = `
            <div class="display-group-header" onclick="toggleDisplayGroupExpansion('${orderId}', '${displayGroup.displayName}')">
                <label onclick="event.stopPropagation();toggleSelectAllInGroup('${orderId}','${displayGroup.displayName}',this)">
                    <input type="checkbox" style="width: 7mm; height: 6mm;" data-order-id="${orderId}" data-group-name="${displayGroup.displayName}">
                </label>
                <div class="display-group-info">
                    <div class="display-group-title">
                        <span>📁</span>
                        <span>${displayGroup.displayName}</span>
                    </div>
                    <div class="display-group-summary">
                        ${displayGroup.components.length} hạng mục • ${displayGroup.componentCount} cấu kiện • ${formatNumber(displayGroup.totalWeight)} kg
                    </div>
                </div>
                <div class="order-actions">
                    <button class="print-btn-nhom" onclick="printCheckedComponentsHorizontal('${orderId}', '${displayGroup.displayName}', event)" style="background: #1976d2; color: #fff; font-size: 12px; padding: 8px 15px;">
                        🖨️ In Tem 3
                    </button>
                    <span class="expand-icon">▼</span>
                </div>
            </div>
            <div class="display-group-content">
                <div class="components-container" data-display-group="${orderId}|||${displayGroup.displayName}">
                </div>
            </div>
        `;

                container.appendChild(displayElement);
            });
        }

        function loadComponents(orderId, displayGroupName) {
            const order = groupedData[orderId];
            if (!order || !order.displayGroups[displayGroupName]) return;

            const container = document.querySelector(`[data-display-group="${orderId}|||${displayGroupName}"]`);
            if (!container) return;

            container.innerHTML = '';

            order.displayGroups[displayGroupName].components.forEach((component, idx) => {
                const componentDiv = document.createElement('div');
                componentDiv.innerHTML = createComponentCardHTML(component, idx, orderId, displayGroupName);
                container.appendChild(componentDiv.firstElementChild);
            });
        }

        function toggleOrderExpansion(safeOrderId) {
            const orderElement = document.getElementById(`order-${safeOrderId}`);

            if (orderElement.classList.contains('expanded')) {
                orderElement.classList.remove('expanded');
            } else {
                orderElement.classList.add('expanded');
                const originalOrderId = Object.keys(groupedData).find(id => generateSafeId(id) === safeOrderId);
                if (originalOrderId) {
                    loadDisplayGroups(originalOrderId);
                }
            }
        }

        function toggleDisplayGroupExpansion(orderId, displayGroupName) {
            const order = groupedData[orderId];
            if (!order || !order.displayGroups[displayGroupName]) return;

            const container = document.querySelector(`[data-display-group="${orderId}|||${displayGroupName}"]`);
            const displayGroupElement = container.closest('.display-group');

            if (displayGroupElement.classList.contains('expanded')) {
                displayGroupElement.classList.remove('expanded');
                container.innerHTML = '';
            } else {
                displayGroupElement.classList.add('expanded');
                loadComponents(orderId, displayGroupName);
            }
        }

        // ===== PRINT FUNCTIONS - TEM NGANG 3 TEM/TRANG XOAY -90 ĐỘ =====
        // CHÚ THÍCH: Đây là hàm in tem cho toàn bộ đơn hàng
        async function printOrderLabelsHorizontal(orderId, event) {
            event.stopPropagation();
            const group = groupedData[orderId];
            if (!group) return;

            document.getElementById('loadingOverlay').classList.add('show');
            const printContainer = document.getElementById('printContainer');
            printContainer.innerHTML = '';

            try {
                let labelCount = 0;
                const fragment = document.createDocumentFragment();

                // Collect all items from all display groups
                const allItems = [];
                Object.values(group.displayGroups).forEach(displayGroup => {
                    allItems.push(...displayGroup.components);
                });

                // Filter items with valid cau_kien
                const validItems = allItems.filter(item => item.cau_kien && item.cau_kien.trim() !== '');

                // Group items into pages of 3
                for (let i = 0; i < validItems.length; i += 3) {
                    const pageItems = validItems.slice(i, i + 3);
                    const labelPage = document.createElement('div');
                    labelPage.className = 'label-page-horizontal';

                    // Create 3 slots, fill with data or leave empty
                    for (let j = 0; j < 3; j++) {
                        const item = pageItems[j];
                        const labelItem = document.createElement('div');
                        labelItem.className = 'label-item-horizontal';

                        if (item) {
                            // CHÚ THÍCH: Tạo QR code - sử dụng item.cau_kien_qr
                            let qrHTML = '';
                            if (item.cau_kien_qr && item.cau_kien_qr.trim() !== '') {
                                const qrURL = generateQRCodeAPI(item.cau_kien_qr, 600);
                                qrHTML = `<img src="${qrURL}" alt="QR Code" onerror="this.style.display='none'">`;
                            } else {
                                qrHTML = `<div style="width: 10mm; height: 10mm; border: 2px dashed #ccc; display: flex; align-items: center; justify-content: center; font-size: 8px; color: #999;">NO QR</div>`;
                            }

                            // CHÚ THÍCH: Đây là template HTML cho mỗi tem in
                            // Để thêm thông tin mới, sửa đổi cấu trúc HTML dưới đây
                            labelItem.innerHTML = `
                                <div class="label-wrapper">
                                    <div class="label-header">${item.ten_kh || ''}</div>
                                    <div class="label-content">
                                        <div class="label-info">
                                            <div class="ten_sp">${item.ten_sp || ''}</div>
                                            <div class="component-name">${item.cau_kien || ''}</div>
                                            <!-- CHÚ THÍCH: THÊM THÔNG TIN MỚI VÀO ĐÂY -->
                                            <!-- Ví dụ thêm khối lượng:
                                            <div class="additional-info">${item.khoi_luong || ''} kg</div>
                                            -->
                                            <!-- Ví dụ thêm số lượng:
                                            <div class="additional-info">SL: ${item.sl_san_xuat || 1}</div>
                                            -->
                                            
                                            <div class="additional-info">${item.quy_cach || ''}</div>
                                            
                                        </div>
                                        <div class="qr-container">
                                            ${qrHTML}
                                            <div class="qr-code-id">${item.don_hang_ct_id || ''}</div>
                                            <!-- CHÚ THÍCH: THÊM THÔNG TIN MỚI DƯỚI QR CODE -->
                                            <!-- Ví dụ:
                                            <div class="qr-additional-info">${item.new_field || ''}</div>
                                            -->
                                        </div>
                                    </div>
                                </div>
                            `;
                        } else {
                            // Empty slot - tem trống khi không đủ 3 tem trong trang
                            labelItem.innerHTML = `
                                <div class="label-wrapper">
                                    <div class="label-header"></div>
                                    <div class="label-content">
                                        <div class="label-info">
                                            <div class="ten_sp"></div>
                                            <div class="component-name"></div>
                                        </div>
                                        <div class="qr-container">
                                            <div style="width: 10mm; height: 10mm;"></div>
                                            <div class="qr-code-id"></div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }

                        labelPage.appendChild(labelItem);
                    }

                    fragment.appendChild(labelPage);
                    labelCount += pageItems.length;
                    await new Promise(resolve => setTimeout(resolve, 50));
                }

                printContainer.appendChild(fragment);
                document.getElementById('loadingOverlay').classList.remove('show');

                if (labelCount > 0) {
                    setTimeout(() => { window.print(); }, 500);
                } else {
                    alert('Không có cấu kiện nào để in trong đơn hàng này.');
                }

            } catch (error) {
                console.error('Error creating labels:', error);
                document.getElementById('loadingOverlay').classList.remove('show');
                alert('Có lỗi xảy ra khi tạo tem. Vui lòng thử lại.');
            }
        }

        function toggleSelectAllInGroup(orderId, displayGroupName, label) {
            const groupCheckbox = label.querySelector('input[type="checkbox"]');
            const checked = groupCheckbox.checked;
            const container = document.querySelector(`[data-display-group="${orderId}|||${displayGroupName}"]`);
            if (!container) return;
            const checkboxes = container.querySelectorAll('.component-checkbox');
            checkboxes.forEach(cb => cb.checked = checked);
        }

        // CHÚ THÍCH: Hàm in tem cho các cấu kiện đã chọn trong một nhóm
        async function printCheckedComponentsHorizontal(orderId, displayGroupName, event) {
            event.stopPropagation();
            const order = groupedData[orderId];
            if (!order || !order.displayGroups[displayGroupName]) return;

            const displayGroup = order.displayGroups[displayGroupName];
            const container = document.querySelector(`[data-display-group="${orderId}|||${displayGroupName}"]`);
            if (!container) return;

            const checkboxes = container.querySelectorAll('.component-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('Vui lòng chọn ít nhất 1 cấu kiện để in!');
                return;
            }

            // CHÚ THÍCH: Lấy danh sách cấu kiện đã chọn và số lượng cần in cho từng cấu kiện
            let selectedItems = [];
            checkboxes.forEach(cb => {
                const idx = parseInt(cb.getAttribute('data-idx'));
                const component = displayGroup.components[idx];
                // Lấy số lượng từ input
                const input = container.querySelector(`input.sl-input[data-idx="${idx}"]`);
                let soLuong = parseInt(component.sl_san_xuat) || 1;
                if (input && !isNaN(parseInt(input.value))) {
                    soLuong = parseInt(input.value);
                }
                // Đưa vào mảng đúng số lượng
                for (let i = 0; i < soLuong; i++) {
                    selectedItems.push(component);
                }
            });

            document.getElementById('loadingOverlay').classList.add('show');
            const printContainer = document.getElementById('printContainer');
            printContainer.innerHTML = '';

            try {
                let labelCount = 0;
                const fragment = document.createDocumentFragment();

                // Group selected items into pages of 3
                for (let i = 0; i < selectedItems.length; i += 3) {
                    const pageItems = selectedItems.slice(i, i + 3);
                    const labelPage = document.createElement('div');
                    labelPage.className = 'label-page-horizontal';

                    // Create 3 slots, fill with data or leave empty
                    for (let j = 0; j < 3; j++) {
                        const item = pageItems[j];
                        const labelItem = document.createElement('div');
                        labelItem.className = 'label-item-horizontal';

                        if (item) {
                            // CHÚ THÍCH: Tạo QR code cho từng tem được chọn
                            let qrHTML = '';
                            if (item.cau_kien_qr && item.cau_kien_qr.trim() !== '') {
                                const qrURL = generateQRCodeAPI(item.cau_kien_qr, 600);
                                qrHTML = `<img src="${qrURL}" alt="QR Code" onerror="this.style.display='none'">`;
                            } else {
                                qrHTML = `<div style="width: 10mm; height: 10mm; border: 2px dashed #ccc; display: flex; align-items: center; justify-content: center; font-size: 8px; color: #999;">NO QR</div>`;
                            }

                            // CHÚ THÍCH: Template HTML giống như hàm printOrderLabelsHorizontal
                            // Để thêm thông tin mới, sửa đổi tương tự như hàm trên
                            labelItem.innerHTML = `
                        <div class="label-wrapper">
                            <div class="label-header">${item.ten_kh || ''}</div>
                            <div class="label-content">
                                <div class="label-info">
                                    <div class="ten_sp">${item.ten_sp || ''}</div>
                                    <div class="component-name">${item.cau_kien || ''}</div>
                                    <div class="additional-info">${item.quy_cach || ''}</div>
                                    <!-- CHÚ THÍCH: THÊM THÔNG TIN MỚI VÀO ĐÂY (tương tự như hàm trên) -->
                                </div>
                                <div class="qr-container">
                                    ${qrHTML}
                                    <div class="qr-code-id">${item.don_hang_ct_id || ''}</div>
                                    <!-- CHÚ THÍCH: THÊM THÔNG TIN MỚI DƯỚI QR CODE -->
                                </div>
                            </div>
                        </div>
                    `;
                        } else {
                            // Empty slot
                            labelItem.innerHTML = `
                        <div class="label-wrapper">
                            <div class="label-header"></div>
                            <div class="label-content">
                                <div class="label-info">
                                    <div class="ten_sp"></div>
                                    <div class="component-name"></div>
                                </div>
                                <div class="qr-container">
                                    <div style="width: 10mm; height: 10mm;"></div>
                                    <div class="qr-code-id"></div>
                                </div>
                            </div>
                        </div>
                    `;
                        }

                        labelPage.appendChild(labelItem);
                    }

                    fragment.appendChild(labelPage);
                    labelCount += pageItems.length;
                    await new Promise(resolve => setTimeout(resolve, 50));
                }

                printContainer.appendChild(fragment);
                document.getElementById('loadingOverlay').classList.remove('show');

                if (labelCount > 0) {
                    // Đợi tất cả ảnh QR code trong printContainer load xong rồi mới in
                    const imgs = printContainer.querySelectorAll('img');
                    if (imgs.length > 0) {
                        Promise.all(Array.from(imgs).map(img => new Promise(resolve => {
                            if (img.complete) resolve();
                            else {
                                img.onload = resolve;
                                img.onerror = resolve;
                            }
                        }))).then(() => {
                            setTimeout(() => { window.print(); }, 100);
                        });
                    } else {
                        setTimeout(() => { window.print(); }, 100);
                    }
                } else {
                    alert('Không có cấu kiện nào để in.');
                }

            } catch (error) {
                console.error('Error creating labels:', error);
                document.getElementById('loadingOverlay').classList.remove('show');
                alert('Có lỗi xảy ra khi tạo tem. Vui lòng thử lại.');
            }
        }

        // AUTO-SCROLL AND SELECTION FUNCTIONS
        function handleAutoScroll(e) {
            const threshold = 50;
            const scrollSpeed = 5;
            const scrollContainer = document.querySelector('.data-container');

            if (!scrollContainer || !isDragging) return;

            const rect = scrollContainer.getBoundingClientRect();
            const mouseY = e.clientY;

            if (mouseY < rect.top + threshold) {
                if (autoScrollTimer) clearInterval(autoScrollTimer);
                autoScrollTimer = setInterval(() => {
                    scrollContainer.scrollTop -= scrollSpeed;
                }, 16);
            } else if (mouseY > rect.bottom - threshold) {
                if (autoScrollTimer) clearInterval(autoScrollTimer);
                autoScrollTimer = setInterval(() => {
                    scrollContainer.scrollTop += scrollSpeed;
                }, 16);
            } else {
                if (autoScrollTimer) {
                    clearInterval(autoScrollTimer);
                    autoScrollTimer = null;
                }
            }
        }

        function handleRangeSelection(currentCheckbox) {
            if (!lastClickedCheckbox || !isShiftPressed) return;

            const orderId = currentCheckbox.getAttribute('data-order-id');
            const groupName = currentCheckbox.getAttribute('data-group-name');
            const lastOrderId = lastClickedCheckbox.getAttribute('data-order-id');
            const lastGroupName = lastClickedCheckbox.getAttribute('data-group-name');

            if (orderId !== lastOrderId || groupName !== lastGroupName) return;

            const container = document.querySelector(`[data-display-group="${orderId}|||${groupName}"]`);
            if (!container) return;

            const allCheckboxes = Array.from(container.querySelectorAll('.component-checkbox'));
            const startIndex = allCheckboxes.indexOf(lastClickedCheckbox);
            const endIndex = allCheckboxes.indexOf(currentCheckbox);

            if (startIndex !== -1 && endIndex !== -1) {
                const minIndex = Math.min(startIndex, endIndex);
                const maxIndex = Math.max(startIndex, endIndex);
                const targetState = currentCheckbox.checked;

                for (let i = minIndex; i <= maxIndex; i++) {
                    allCheckboxes[i].checked = targetState;
                }
            }
        }

        function handleDragSelection(currentCheckbox) {
            if (!isDragging || !dragStartCheckbox) return;

            const orderId = currentCheckbox.getAttribute('data-order-id');
            const groupName = currentCheckbox.getAttribute('data-group-name');
            const dragOrderId = dragStartCheckbox.getAttribute('data-order-id');
            const dragGroupName = dragStartCheckbox.getAttribute('data-group-name');

            if (orderId !== dragOrderId || groupName !== dragGroupName) return;

            const container = document.querySelector(`[data-display-group="${orderId}|||${groupName}"]`);
            if (!container) return;

            const allCheckboxes = Array.from(container.querySelectorAll('.component-checkbox'));
            const startIndex = allCheckboxes.indexOf(dragStartCheckbox);
            const endIndex = allCheckboxes.indexOf(currentCheckbox);

            if (startIndex !== -1 && endIndex !== -1) {
                const minIndex = Math.min(startIndex, endIndex);
                const maxIndex = Math.max(startIndex, endIndex);

                if (window.dragOriginalStates) {
                    allCheckboxes.forEach((cb, idx) => {
                        cb.checked = window.dragOriginalStates[idx];
                    });
                }

                for (let i = minIndex; i <= maxIndex; i++) {
                    allCheckboxes[i].checked = true;
                }
            }
        }

        function handleCheckboxChange(checkbox) {
            if (isShiftPressed && lastClickedCheckbox) {
                handleRangeSelection(checkbox);
            } else {
                lastClickedCheckbox = checkbox;
            }
        }

        function handleMouseDown(checkbox, event) {
            if (isShiftPressed) {
                event.preventDefault();
                isDragging = true;
                dragStartCheckbox = checkbox;

                const orderId = checkbox.getAttribute('data-order-id');
                const groupName = checkbox.getAttribute('data-group-name');
                const container = document.querySelector(`[data-display-group="${orderId}|||${groupName}"]`);
                if (container) {
                    const allCheckboxes = Array.from(container.querySelectorAll('.component-checkbox'));
                    window.dragOriginalStates = allCheckboxes.map(cb => cb.checked);
                }

                checkbox.checked = true;
            } else {
                lastClickedCheckbox = checkbox;
            }
        }

        function handleMouseEnter(checkbox, event) {
            if (isShiftPressed && isDragging) {
                handleDragSelection(checkbox);
                handleAutoScroll(event);
            }
        }

        function updateSummary(data) {
            const totalOrders = Object.keys(data).length;
            let totalDisplayGroups = 0;
            let totalComponents = 0;
            let totalWeight = 0;

            Object.values(data).forEach(order => {
                totalDisplayGroups += order.totalDisplayGroups;
                totalComponents += order.totalComponents;
                totalWeight += order.totalWeight;
            });

            document.getElementById('totalOrders').textContent = formatNumber(totalOrders);
            document.getElementById('totalDisplayGroups').textContent = formatNumber(totalDisplayGroups);
            document.getElementById('totalComponents').textContent = formatNumber(totalComponents);
            document.getElementById('totalWeight').textContent = formatNumber(totalWeight) + ' kg';
            document.getElementById('summaryBar').style.display = 'flex';
        }

        const debouncedFilter = debounce((searchTerm) => {
            if (!searchTerm.trim()) {
                filteredData = allData;
            } else {
                const term = searchTerm.toLowerCase();
                // CHÚ THÍCH: Để thêm field mới vào tìm kiếm, thêm vào điều kiện filter dưới đây
                filteredData = allData.filter(item =>
                    (item.don_hang_id && item.don_hang_id.toLowerCase().includes(term)) ||
                    (item.ten_kh && item.ten_kh.toLowerCase().includes(term)) ||
                    (item.ten_sp && item.ten_sp.toLowerCase().includes(term)) ||
                    (item.cau_kien && item.cau_kien.toLowerCase().includes(term)) ||
                    (item.hien_thi && item.hien_thi.toLowerCase().includes(term))
                    // || (item.new_field && item.new_field.toLowerCase().includes(term))  // Thêm field mới
                );
            }

            groupedData = groupDataHierarchically(filteredData);
            renderHierarchicalData(groupedData);
            updateSummary(groupedData);
        }, 300);

        function showError(message) {
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorDiv').style.display = 'block';
        }

        function showData() {
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('dataContainer').style.display = 'block';
        }

        // CHÚ THÍCH: Hàm khởi tạo - tải dữ liệu từ API
        async function initialize() {
            try {
                let data = await fetchLSXData();
                // CHÚ THÍCH: Lọc dữ liệu - loại bỏ các dòng có lỗi
                data = data.filter(item =>
                    item.khoi_luong_dv &&
                    item.cau_kien_qr &&
                    // item.quy_cach &&
                    item.khoi_luong_dv !== "#DIV/0!" &&
                    item.cau_kien_qr !== "#DIV/0!"
                    // && item.new_field !== "#DIV/0!"  // Thêm filter cho field mới nếu cần
                );
                allData = data;
                filteredData = data;
                groupedData = groupDataHierarchically(filteredData);

                renderHierarchicalData(groupedData);
                updateSummary(groupedData);
                showData();
            } catch (error) {
                showError(`Không thể tải dữ liệu: ${error.message}`);
            }
        }

        // Event Listeners
        document.addEventListener('mousemove', function (e) {
            if (isShiftPressed && isDragging) {
                handleAutoScroll(e);
            }
        });

        document.addEventListener('mouseup', function (e) {
            if (isShiftPressed && isDragging) {
                isDragging = false;
                dragStartCheckbox = null;
                window.dragOriginalStates = null;

                if (autoScrollTimer) {
                    clearInterval(autoScrollTimer);
                    autoScrollTimer = null;
                }
            }
        });

        document.addEventListener('keydown', function (e) {
            if (e.key === 'Shift') {
                isShiftPressed = true;
                document.body.style.cursor = 'crosshair';
                document.body.classList.add('shift-mode');
            }
        });

        document.addEventListener('keyup', function (e) {
            if (e.key === 'Shift') {
                isShiftPressed = false;
                document.body.style.cursor = '';
                document.body.classList.remove('shift-mode');
                isDragging = false;
                dragStartCheckbox = null;
                window.dragOriginalStates = null;

                if (autoScrollTimer) {
                    clearInterval(autoScrollTimer);
                    autoScrollTimer = null;
                }
            }
        });

        document.addEventListener('mouseleave', function (e) {
            if (autoScrollTimer) {
                clearInterval(autoScrollTimer);
                autoScrollTimer = null;
            }
        });

        // Make functions global
        window.toggleOrderExpansion = toggleOrderExpansion;
        window.toggleDisplayGroupExpansion = toggleDisplayGroupExpansion;
        window.printOrderLabelsHorizontal = printOrderLabelsHorizontal;
        window.printCheckedComponentsHorizontal = printCheckedComponentsHorizontal;
        window.toggleSelectAllInGroup = toggleSelectAllInGroup;
        window.handleCheckboxChange = handleCheckboxChange;
        window.handleMouseDown = handleMouseDown;
        window.handleMouseEnter = handleMouseEnter;

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', function () {
                debouncedFilter(this.value);
            });

            initialize();
        });
    </script>
</body>

</html>
