<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HGPT - Tem tr√¨nh m·∫´u D·ª± √°n (70√ó105mm ‚Ä¢ 3 tem/trang)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root{
      /* K√çCH TH∆Ø·ªöC TRANG IN & TEM */
      --sheet-w: 105mm;    /* 3 tem x 35mm */
      --sheet-h: 70mm;     /* cao 70mm */
      --label-w: 35mm;
      --label-h: 70mm;
      --gap: 2mm;          /* kho·∫£ng c√°ch gi·ªØa tem (hi·ªÉn th·ªã) */
      --pad: 3mm;
      --font: "Times New Roman", Times, serif;
    }

    *{ box-sizing: border-box; }
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:#f3f5f8; color:#0f172a;
    }
    .wrap{ max-width:960px; margin:24px auto; padding:16px; background:#fff; border-radius:14px; box-shadow:0 8px 24px rgba(2,6,23,.08); }
    h1{ font-size:28px; margin:0 0 12px; padding:12px 0 0 0; color:rgb(129,95,8) }
    .row{ display:flex; gap:12px; align-items:center; margin-bottom:8px; flex-wrap:wrap; }
    button, a.link{
      padding:10px 18px; border-radius:10px; border:2px solid #ffad56; background:#fff; color:#ff7a00;
      font-weight:700; cursor:pointer; text-decoration:none;
    }
    button:hover, a.link:hover{ background:#ffad56; color:#fff; }
    .status{ font-size:16px; color:#475569; margin-left:8px; }
    .note{ font-size:14px; color:#64748b; margin-top:4px; }

    /* V√ôNG IN */
    .print-container{ display:none; }

    @media print{
      @page{ size: var(--sheet-w) var(--sheet-h); margin:0; }

      .wrap{ display:none !important; }
      .print-container{ display:block; position:absolute; inset:0; padding:0; }

      /* M·ªói TRANG IN (SHEET) ch·ª©a 3 TEM */
      .sheet{
        width: var(--sheet-w);
        height: var(--sheet-h);
        display:grid;
        grid-template-columns: repeat(3, var(--label-w));
        grid-auto-rows: var(--label-h);
        justify-content:start;
        align-content:start;
        gap: 0;                   /* kh√¥ng ch·ª´a r√£nh th·ª±c t·∫ø ƒë·ªÉ tr√°nh sai k√≠ch th∆∞·ªõc */
        background:#fff;
        position: relative;
        break-inside: avoid;
        page-break-after: always; /* m·ªói .sheet l√† 1 trang in */
      }

      /* ƒê∆∞·ªùng c·∫Øt/d·∫•u g·∫°ch gi·ªØa 3 tem (ch·ªâ hi·ªÉn th·ªã, kh√¥ng tƒÉng k√≠ch th∆∞·ªõc) */
      .sheet::before,
      .sheet::after{
        content:"";
        position:absolute; top:0; bottom:0; width:0;
        border-left: 1px dashed #999;
        pointer-events:none;
      }
      .sheet::before{ left: var(--label-w); }         /* v·∫°ch t·∫°i 35mm */
      .sheet::after{  left: calc(var(--label-w) * 2); }/* v·∫°ch t·∫°i 70mm */

      .label{
        width: var(--label-w);
        height: var(--label-h);
        padding: 4mm var(--pad) var(--pad) var(--pad); /* √©p n·ªôi dung l√™n tr√™n m·ªôt ch√∫t */
        display:flex;
        align-items:flex-start;
        justify-content:flex-start;
        background:#fff;
      }
      .text{ line-height:1.06; width:100%; }
      .stt{ font-family:var(--font); font-size:10pt; font-weight:700; color:#000; margin-bottom:1mm; }
      .ten{ font-family:var(--font); font-weight:700; font-size:12pt; text-transform:uppercase; }
      .meta{ font-family:var(--font); font-size:10.5pt; margin-top:1mm; }
      .meta b{ font-weight:700; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <img src="https://hgptsteel.com/wp-content/uploads/2025/06/cropped-HGPT-STEEL-1-1.png" alt="HGPT Logo" style="height:38px; vertical-align:middle;">
    <h1>Tem m·∫´u v·∫≠t t∆∞ D·ª± √°n</h1>
    <div class="row">
      <button id="btnPrint">üñ®Ô∏è IN TEM</button>
      <a id="sheetLink" href="#" class="link" target="_blank">üîó M·ªü link Sheet n·ªÅn</a>
      <span class="status" id="status">
        <i class="fa-solid fa-check fa-xl" style="color:#004ffa;"></i>
        S·∫µn s√†ng in r·ªìi :)
      </span>
    </div>
    <div class="note">
      Ngu·ªìn d·ªØ li·ªáu: Google Sheet t·∫°i <b>"Sheet1"</b> g·ªìm c√°c c·ªôt:<br>------<br>
      <b>1. STT</b>,<br><b>2. CHUNGLOAI-QUYCACH</b>,<br> <b>3. VATLIEU</b>,<br> <b>4. VITRI</b>,<br> <b>5. SOLUONG</b>.<br>
      -------<br><b>**In theo th·ª© t·ª± ·ªü c·ªôt STT**</b>
    </div>
  </div>

  <div class="print-container" id="printContainer"></div>

  <script>
  // ====== C·∫§U H√åNH ======
  const GOOGLE_SHEET_ID = '1NfxVAG9r1i6-Kb5GoxPSQ9yN2RmEi6SLeNlVRFzHAE0';
  const SHEET_NAME      = 'Sheet1';

  document.addEventListener('DOMContentLoaded', () => {
    const $ = (s)=>document.querySelector(s);
    const statusEl       = $('#status');
    const printContainer = $('#printContainer');
    const sheetLink      = $('#sheetLink');
    const btnPrint       = $('#btnPrint');

    if (sheetLink) {
      sheetLink.href = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/edit#gid=0`;
    }

    async function fetchSheetGViz(sheetId, sheetName){
      const url  = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
      const resp = await fetch(url);
      const text = await resp.text();
      const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
      const headers = (json.table.cols || []).map((c, i) => (c && c.label) ? c.label : `Col${i+1}`);
      const rows = [];
      for (const r of json.table.rows){
        if (!r || !r.c) continue;
        const o = {};
        headers.forEach((h, i) => { o[h] = r.c[i] ? (r.c[i].v ?? '') : ''; });
        rows.push(o);
      }
      return rows;
    }

    const norm = s => String(s||'').toLowerCase().replace(/\s+/g,'');
    function pick(obj, names){
      const keys = Object.keys(obj);
      for (const want of names){
        const hitKey = keys.find(k => norm(k) === norm(want));
        if (hitKey !== undefined) return obj[hitKey];
      }
      return '';
    }

    // T·∫°o 1 node tem (label)
    function makeLabel({STT, CHUNGLOAI, VATLIEU, VITRI}){
      const div = document.createElement('div');
      div.className = 'label';
      div.innerHTML = `
        <div class="text">
          <div class="stt">STT: ${STT || ''}</div>
          <div class="ten">${(CHUNGLOAI||'').toString().toUpperCase()}</div>
          <div class="meta">
            <b>VL:</b> ${VATLIEU || ''} &nbsp;|&nbsp;
            <b>VT:</b> ${VITRI || ''}
          </div>
        </div>`;
      return div;
    }

    async function printFromSheet(){
      statusEl.textContent = 'ƒêang t·∫£i d·ªØ li·ªáu Sheet...';
      printContainer.innerHTML = '';

      let rows;
      try{
        rows = await fetchSheetGViz(GOOGLE_SHEET_ID, SHEET_NAME);
      }catch(e){
        statusEl.textContent = 'L·ªói t·∫£i Sheet';
        alert('Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c d·ªØ li·ªáu Google Sheet:\n' + e.message);
        return;
      }

      if (!rows.length){
        statusEl.textContent = 'Kh√¥ng c√≥ d·ªØ li·ªáu.';
        alert('Sheet tr·ªëng ho·∫∑c kh√¥ng c√≥ h√†ng d·ªØ li·ªáu.');
        return;
      }

      // sort theo STT
      rows.sort((a,b)=>{
        const A = Number(pick(a, ['STT','stt'])) || 0;
        const B = Number(pick(b, ['STT','stt'])) || 0;
        return A - B;
      });

      statusEl.textContent = 'ƒêang t·∫°o tem...';

      // Gom 3 tem / 1 sheet (trang)
      let sheet    = null;
      let cellInPg = 0;
      let total    = 0;

      for (const r of rows){
        const STT       = pick(r, ['STT','stt']);
        const CHUNGLOAI = String(pick(r, ['CHUNGLOAI','CHUNGLOAI-QUYCACH','Ch·ªßng lo·∫°i','chungloai'])||'').trim();
        const VATLIEU   = String(pick(r, ['VATLIEU','V·∫≠t li·ªáu','vatlieu'])||'').trim();
        const VITRI     = String(pick(r, ['VITRI','V·ªã tr√≠','vitri'])||'').trim();
        const SLraw     = pick(r, ['SOLUONG','Soluong','SL','soluong']);
        const SL        = Number.parseInt(SLraw,10);

        if (!SLraw || isNaN(SL) || SL <= 0) continue;
        if (!CHUNGLOAI) continue;

        for (let i=0; i<SL; i++){
          // t·∫°o sheet m·ªõi n·∫øu h·∫øt trang ho·∫∑c ch∆∞a c√≥
          if (!sheet || cellInPg === 3){
            sheet = document.createElement('div');
            sheet.className = 'sheet';
            printContainer.appendChild(sheet);
            cellInPg = 0;
          }
          sheet.appendChild(
            makeLabel({STT, CHUNGLOAI, VATLIEU, VITRI})
          );
          cellInPg++;
          total++;
        }
      }

      if (!total){
        statusEl.textContent = 'Kh√¥ng c√≥ b·∫£n ghi h·ª£p l·ªá.';
        alert('Thi·∫øu CHUNGLOAI ho·∫∑c SOLUONG = 0 ·ªü m·ªçi h√†ng.');
        return;
      }

      statusEl.textContent = `ƒê√£ t·∫°o ${total} tem ‚Ä¢ m·ªü h·ªôp tho·∫°i in...`;
      setTimeout(()=>{ window.print(); statusEl.textContent = 'S·∫µn s√†ng'; }, 120);
    }

    if (btnPrint) btnPrint.addEventListener('click', printFromSheet);
  });
  </script>
</body>
</html>
