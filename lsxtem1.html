<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HGPT Steel - Tem QR</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }

        /* Responsive header and search for mobile */
        @media (max-width: 700px) {
            .header-flex {
                flex-direction: column;
                align-items: stretch;
                padding: 12px 8px;
                gap: 10px;
                border-radius: 0 0 10px 10px;
            }

            .header-title {
                align-items: flex-start;
                text-align: left;
            }

            .search-container {
                min-width: 0;
                max-width: 100%;
                width: 100%;
                margin-top: 6px;
            }

            .search-box {
                font-size: 15px;
                padding: 10px 40px 10px 14px;
            }

            .search-icon {
                right: 12px;
                font-size: 18px;
            }
        }

        .header-flex {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, #ff9a56 0%, #ffad56 100%);
            color: white;
            padding: 10px 25px;
            border-radius: 0 0 20px 20px;
            margin-bottom: 10px;
        }

        .header-title {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .header-title h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 0;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .header-title .subtitle {
            font-size: 16px;
            opacity: 0.9;
            font-weight: 300;
        }

        .search-container {
            position: relative;
            max-width: 500px;
            margin: 0 auto;
        }

        .search-box {
            width: 100%;
            padding: 10px 50px 10px 20px;
            border: 3px solid transparent;
            border-radius: 30px;
            font-size: 16px;
            background: white;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: #ff9a56;
            box-shadow: 0 5px 30px rgba(255, 154, 86, 0.3);
        }

        .search-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 20px;
            color: #ff9a56;
        }

        .loading {
            text-align: center;
            padding: 80px 20px;
            color: #6c757d;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #e9ecef;
            border-top: 5px solid #ff9a56;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 30px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @media print {
            #dataContainer {
                display: none !important;
                visibility: hidden !important;
                height: 0 !important;
                overflow: hidden !important;
            }

            .container {
                display: none !important;
            }
        }

        .data-container {
            padding: 10px 25px 25px;
            overflow-y: auto;
        }

        /* ORDER LEVEL - Level 1 */
        .order-item {
            margin-bottom: 20px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
            background: white;
        }

        .order-header {
            background: linear-gradient(135deg, #ff9a56 0%, #ffad56 100%);
            color: white;
            padding: 10px 25px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.2s ease;
        }

        .order-header:hover {
            transform: translateY(-2px);
        }

        .order-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .order-title {
            font-size: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .order-summary {
            font-size: 14px;
            opacity: 0.9;
        }

        .order-actions {
            display: flex;
            align-items: center;
            justify-items: end;
            gap: 15px;
        }

        .print-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .print-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: scale(1.05);
        }

        .print-btn-nhom {
            background: rgba(255, 255, 255, 0.2);
            color: #1976d2;
            border: 2px solid #1976d2;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .print-btn-nhom:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: scale(1.05);
        }

        .expand-icon {
            font-size: 24px;
            transition: transform 0.2s ease;
        }

        .order-item.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .order-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
            background: #f8f9fa;
        }

        .order-item.expanded .order-content {
            max-height: none;
        }

        /* DISPLAY GROUP LEVEL - Level 2 */
        .display-groups-container {
            padding: 15px;
        }

        .display-group {
            margin-bottom: 15px;
            border-radius: 10px;
            overflow: hidden;
            background: white;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.08);
        }

        .display-group-header {
            background: #f5f7fa;
            /* x√°m xanh r·∫•t nh·∫°t */
            color: #1976d2;
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }

        .display-group-header:hover {
            transform: translateY(-1px);
        }

        .display-group-info {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .display-group-title {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .display-group-summary {
            font-size: 13px;
            opacity: 0.9;
        }

        .display-group-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: #f1f3f4;
        }

        /* Cho ph√©p n·ªôi dung t·ª± ƒë·ªông xu·ªëng d√≤ng, kh√¥ng b·ªã c·∫Øt */
        .component-row,
        .component-card {
            white-space: normal;
            word-break: break-word;
            overflow: visible;
            height: auto;
            min-height: 0;
            max-height: none;
            align-items: flex-start;
        }

        .display-group.expanded .display-group-content {
            max-height: none;
        }

        /* COMPONENT LEVEL - Level 3 */

        .component-row {
            display: flex;
            align-items: center;
            padding: 8px 14px;
            border-radius: 0;
            box-shadow: none;
            border-bottom: 1px solid #f1f3f4;
            background: #fff;
            margin-bottom: 0;
            font-size: 14px;
            gap: 0;
        }

        .component-row:last-child {
            border-bottom: none;
        }

        .cau-kien-tag {
            background: #28a745;
            color: #fff;
            padding: 2px 10px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
        }

        .components-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .component-card {
            background: white;
            border-radius: 10px;
            padding: 12px 18px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            transition: all 0.2s ease;
            border-left: 4px solid #28a745;
            margin-bottom: 0;
            display: grid;
            grid-template-columns: 20px 120px 120px 80px  180px 1fr;
            gap: 15px;
            align-items: center;
            min-height: 50px;
        }

        .component-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        /* ƒê·ªãnh nghƒ©a layout cho t·ª´ng c·ªôt */
        .component-checkbox {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }

        .component-column {
            display: flex;
            align-items: center;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .component-column.cau-kien-col {
            justify-self: start;
        }

        .component-column.ten-sp-col {
            line-height: 1.3;
            padding-right: 10px;
        }

        .component-column.weight-col {
            width: 70px;
            flex-shrink: 0;
            font-size: 14px;
            /*c·ªôt kh·ªëi l∆∞·ª£ng*/
            font-weight: 400;
            text-align: right;
        }

        .component-column.qc-col {
            width: 200px;
            flex-shrink: 0;
            font-size: 14px;
            /*c·ªôt quy c√°ch*/
            font-weight: 500;
            color: darkred;
            text-align: right;
        }

        .component-column.quantity-col {
            width: 120px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .component-column.qr-col {
            width: 180px;
            flex-shrink: 0;
            font-size: 10px;
            color: #888;
            text-align: right;
        }

        .sl-input {
            width: 90px !important;
            height: 35px !important;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 5px 8px;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            transition: all 0.2s ease;
        }

        .sl-input:focus {
            outline: none;
            border-color: #ff9a56;
            box-shadow: 0 0 0 3px rgba(255, 154, 86, 0.1);
        }

        .cau-kien-tag {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }

        .error {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            padding: 25px;
            margin: 25px;
            border-radius: 15px;
            text-align: center;
        }

        .summary-bar {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 10px 25px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .summary-item {
            text-align: center;
        }

        .summary-label {
            font-size: 12px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .summary-value {
            font-size: 20px;
            font-weight: 700;
        }

        /* ===== PRINT STYLES - TEM 1 (70mm x 35mm) ===== */
        .print-container {
            display: none;
        }

        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
            }

            body {
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
            }

            body * {
                visibility: hidden;
            }

            .print-container,
            .print-container * {
                visibility: visible;
            }

            .print-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100% !important;
                height: 100% !important;
                display: block !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            /* K√≠ch th∆∞·ªõc trang tem 70mm x 35mm */
            @page {
                size: 70mm 35mm;
                margin: 0;
            }

            /* M·ªói tem chi·∫øm to√†n b·ªô trang */
            .label-page {
                width: 70mm;
                height: 35mm;
                page-break-after: always;
                page-break-before: avoid;
                page-break-inside: avoid;
                margin: 0;
                padding: 0 2mm 2mm 2mm;
                box-sizing: border-box;
                display: flex;
                flex-direction: column;
                font-family: Arial, sans-serif;
                background: white;
            }

            .label-page:last-child {
                page-break-after: avoid;
            }

            /* === C√ÅC TH√ÄNH PH·∫¶N TH√îNG TIN TR√äN TEM === */

            /* Header - T√™n kh√°ch h√†ng */
            .label-header {
                width: 90%;
                font-size: 11px;
                font-weight: bold;
                line-height: 1.3;
                color: #000;
                word-wrap: break-word;
                overflow-wrap: break-word;
                margin-bottom: 2mm;
                /* CH√ö TH√çCH: ƒê√¢y l√† v√πng hi·ªÉn th·ªã T√äN KH√ÅCH H√ÄNG (item.ten_kh) */
                /* ƒê·ªÉ th√™m th√¥ng tin m·ªõi v√†o header, c√≥ th·ªÉ th√™m div con ho·∫∑c s·ª≠a trong labelPage.innerHTML */
            }

            /* Container ch√≠nh ch·ª©a th√¥ng tin v√† QR code */
            .label-content {
                display: flex;
                align-items: stretch;
                gap: 1mm;
            }

            /* Ph·∫ßn th√¥ng tin b√™n tr√°i */
            .label-info {
                flex: 1;
                display: flex;
                flex-direction: column;
                justify-content: center;
                gap: 1mm;
            }

            /* T√™n s·∫£n ph·∫©m */
            .label-info .ten_sp {
                font-size: 13px;
                color: #000;
                word-wrap: break-word;
                line-height: 1.1;
                /* CH√ö TH√çCH: ƒê√¢y l√† T√äN S·∫¢N PH·∫®M (item.ten_sp) */
                /* Hi·ªÉn th·ªã ·ªü v·ªã tr√≠ ƒë·∫ßu ti√™n trong .label-info */
            }

            /* M√£ c·∫•u ki·ªán - hi·ªÉn th·ªã v·ªõi font ƒë·∫≠m */
            .label-info .component-name {
                font-size: 13px;
                font-weight: bold;
                color: #000;
                word-wrap: break-word;
                line-height: 1.1;
                margin-top: 4mm;
                /* CH√ö TH√çCH: ƒê√¢y l√† M√É C·∫§U KI·ªÜN (item.cau_kien) */
                /* Hi·ªÉn th·ªã ·ªü v·ªã tr√≠ th·ª© hai trong .label-info v·ªõi font ƒë·∫≠m v√† c√°ch 4mm t·ª´ tr√™n */
            }

            /* CH√ö TH√çCH: V·ªä TR√ç TH√äM TH√îNG TIN M·ªöI TRONG .label-info */
            /* ƒê·ªÉ th√™m th√¥ng tin m·ªõi, c√≥ th·ªÉ th√™m class CSS nh∆∞ sau: */
            /*
            .label-info .additional-info {
                font-size: 12px;
                color: #333;
                word-wrap: break-word;
                line-height: 1.2;
                margin-top: 1mm;
            }
            */

            /* Container QR code b√™n ph·∫£i */
            .qr-container {
                width: 15mm;
                margin-right: 4mm;
                display: flex;
                flex-direction: column;
                gap: 1mm;
                /* CH√ö TH√çCH: Container ch·ª©a QR code v√† th√¥ng tin b·ªï sung */
            }

            /* K√≠ch th∆∞·ªõc QR code */
            .qr-container img {
                width: 10mm !important;
                height: 10mm !important;
                max-width: 10mm !important;
                max-height: 10mm !important;
                /* CH√ö TH√çCH: QR Code ƒë∆∞·ª£c t·∫°o t·ª´ item.cau_kien_qr */
            }

            /* ID ƒë∆°n h√†ng chi ti·∫øt d∆∞·ªõi QR code */
            .qr-code-id {
                font-size: 12px;
                color: #000;
                line-height: 1;
                /* CH√ö TH√çCH: ƒê√¢y l√† ID CHI TI·∫æT ƒê∆†N H√ÄNG (item.don_hang_ct_id) */
                /* Hi·ªÉn th·ªã d∆∞·ªõi QR code */
            }

            /* CH√ö TH√çCH: V·ªä TR√ç TH√äM TH√îNG TIN M·ªöI D∆Ø·ªöI QR CODE */
            /* ƒê·ªÉ th√™m th√¥ng tin m·ªõi d∆∞·ªõi QR code, c√≥ th·ªÉ th√™m class CSS nh∆∞ sau: */
            /*
            .qr-additional-info {
                font-size: 10px;
                color: #666;
                text-align: center;
                margin-top: 1mm;
            }
            */
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-message {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        /* Th√™m v√†o ph·∫ßn CSS */
        .shift-mode {
            user-select: none;
        }

        .shift-mode .component-checkbox {
            cursor: crosshair !important;
        }

        .component-checkbox:focus {
            outline: 2px solid #3b82f6;
            outline-offset: 1px;
        }

        .drag-selecting {
            background-color: #dbeafe !important;
            border-left-color: #3b82f6 !important;
        }

        /* Animation cho auto-scroll */
        .data-container {
            scroll-behavior: smooth;
        }

        .data-container.dragging {
            scroll-behavior: auto;
        }

        .switch-page-btns {
            display: flex;
            gap: 12px;
            margin: 18px 0;
            justify-content: flex-end;
        }

        .switch-page-btns button {
            background: #fff;
            color: #ff9a56;
            border: 2px solid #ffad56;
            border-radius: 18px;
            padding: 9px 28px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(255, 154, 86, 0.12);
            transition: background 0.2s, color 0.2s, box-shadow 0.2s;
        }

        .switch-page-btns button:hover {
            background: #ffad56;
            color: #fff;
            box-shadow: 0 4px 16px rgba(255, 154, 86, 0.22);
        }

        .switch-page-btns button.active,
        .switch-page-btns button:disabled {
            background: #ff9a56;
            color: #fff;
            border: 2px solid #ffad56;
            cursor: default;
            box-shadow: 0 2px 8px rgba(255, 154, 86, 0.12);
            opacity: 1;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header-flex">
            <div class="header-title">
                <h1>HGPT STEEL</h1>
                <p class="subtitle">In Tem LSX - Tem 1</p>
            </div>
            <div class="search-container">
                <input type="text" class="search-box" id="searchInput"
                    placeholder="T√¨m ki·∫øm theo ƒë∆°n h√†ng, kh√°ch h√†ng, s·∫£n ph·∫©m...">
                <span class="search-icon">üîç</span>
            </div>
            <div class="switch-page-btns">
                <button class="active" disabled>M·∫´u Tem 1</button>
                <button onclick="window.location.href='https://hknguyen-vn.github.io/ordertrack_hgptsteel/lsxtem3.html'">M·∫´u Tem 3</button>
            </div>
        </div>

        <div class="summary-bar" id="summaryBar" style="display: none;">
            <div class="summary-item">
                <div class="summary-label">T·ªïng ƒë∆°n h√†ng</div>
                <div class="summary-value" id="totalOrders">0</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">T·ªïng h·∫°ng m·ª•c</div>
                <div class="summary-value" id="totalDisplayGroups">0</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">T·ªïng c·∫•u ki·ªán</div>
                <div class="summary-value" id="totalComponents">0</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">Kh·ªëi l∆∞·ª£ng</div>
                <div class="summary-value" id="totalWeight">0 kg</div>
            </div>
        </div>

        <div class="loading" id="loadingDiv">
            <div class="loading-spinner"></div>
            <p>ƒêang t·∫£i d·ªØ li·ªáu t·ª´ h·ªá th·ªëng...</p>
        </div>

        <div class="error" id="errorDiv" style="display: none;">
            <h4>‚ö†Ô∏è C√≥ l·ªói x·∫£y ra</h4>
            <p id="errorMessage"></p>
        </div>

        <div class="data-container" id="dataContainer" style="display: none;">
        </div>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-message">
            <div class="loading-spinner"></div>
            <p>ƒêang t·∫°o tem... Vui l√≤ng ƒë·ª£i</p>
        </div>
    </div>

    <div class="print-container" id="printContainer">
    </div>

    <script>
        // Constants
        const appId = '977c97bd-47e4-441c-b564-fe28574e9d74';
        const accessKey = 'V2-sJNk8-IQldL-7uQ80-Iekic-SvMjg-FPH9j-DFCgG-v97aL';
        const region = 'www';

        let allData = [];
        let filteredData = [];
        let groupedData = {};

        // Thay th·∫ø ph·∫ßn code x·ª≠ l√Ω Shift selection hi·ªán t·∫°i
        let isShiftPressed = false;
        let lastClickedCheckbox = null;
        let isDragging = false;
        let dragStartCheckbox = null;
        let autoScrollTimer = null;

        // T·∫°o QR code b·∫±ng API
        function generateQRCodeAPI(text, size = 300) {
            if (!text || text.trim() === '') text = 'NO-DATA';
            // Kh√¥ng lo·∫°i b·ªè k√Ω t·ª± ƒë·∫∑c bi·ªát, ch·ªâ encodeURIComponent
            return `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encodeURIComponent(text)}&charset-source=UTF-8&charset-target=UTF-8`;
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => { clearTimeout(timeout); func(...args); };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        async function fetchLSXData() {
            try {
                const response = await fetch(`https://${region}.appsheet.com/api/v2/apps/${appId}/tables/LSX/Action`, {
                    method: 'POST',
                    headers: {
                        'ApplicationAccessKey': accessKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        Action: 'Find',
                        Properties: {},
                        Selector: "Filter(LSX, true)"
                    })
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                if (!Array.isArray(data)) throw new Error('Invalid data format received');
                return data;
            } catch (error) {
                console.error('Failed to fetch LSX data:', error);
                throw error;
            }
        }

        // Group data hierarchically: Order > Display Group > Components
        function groupDataHierarchically(data) {
            const grouped = {};

            data.forEach(item => {
                const orderId = item.don_hang_id || 'Kh√¥ng c√≥ ƒë∆°n h√†ng';
                const displayGroup = item.hien_thi || 'Kh√¥ng c√≥ nh√≥m hi·ªÉn th·ªã';

                if (!grouped[orderId]) {
                    grouped[orderId] = {
                        orderId: orderId,
                        customerName: item.ten_kh || '',
                        displayGroups: {},
                        totalWeight: 0,
                        totalComponents: 0,
                        totalDisplayGroups: 0
                    };
                }

                if (!grouped[orderId].displayGroups[displayGroup]) {
                    grouped[orderId].displayGroups[displayGroup] = {
                        displayName: displayGroup,
                        components: [],
                        totalWeight: 0,
                        componentCount: 0
                    };
                    grouped[orderId].totalDisplayGroups += 1;
                }

                grouped[orderId].displayGroups[displayGroup].components.push(item);

                if (item.cau_kien && item.cau_kien.trim() !== '') {
                    grouped[orderId].displayGroups[displayGroup].componentCount += 1;
                    grouped[orderId].totalComponents += 1;
                }

                const weight = parseFloat(item.khoi_luong) || 0;
                grouped[orderId].displayGroups[displayGroup].totalWeight += weight;
                grouped[orderId].totalWeight += weight;
            });

            return grouped;
        }

        function formatNumber(value) {
            if (value === null || value === undefined || value === '') return '0';
            const num = parseFloat(value);
            if (isNaN(num)) return '0';
            return num.toLocaleString('vi-VN');
        }

        // CH√ö TH√çCH: H√†m t·∫°o HTML cho component card trong danh s√°ch
        // ƒê√¢y l√† n∆°i hi·ªÉn th·ªã th√¥ng tin component tr√™n giao di·ªán ch√≠nh
        function createComponentCardHTML(component, idx, orderId, displayGroupName) {
            const safeId = `ck_${orderId}_${displayGroupName}_${idx}`;
            return `
        <div class="component-card component-row">
            <input type="checkbox" class="component-checkbox" id="${safeId}" 
                data-order-id="${orderId}" data-group-name="${displayGroupName}" data-idx="${idx}" checked
                onchange="handleCheckboxChange(this)"
                onmousedown="handleMouseDown(this, event)"
                onmouseenter="handleMouseEnter(this, event)">
            
            <div class="component-column cau-kien-col">
                <span class="cau-kien-tag">${component.cau_kien || ''}</span>
            </div>
            
            <div class="component-column quantity-col">
                <span>SL:</span>
                <input type="number" min="1" value="${component.sl_san_xuat || 1}" 
                    class="sl-input" data-idx="${idx}" />
            </div>
            
            <div class="component-column weight-col">
                <span>${component.khoi_luong || ''} kg</span>
            </div>

            <div class="component-column qc-col">
                <span>${component.quy_cach || ''}</span>
            </div>

            <div class="component-column ten-sp-col">
                <span>${component.ten_sp || ''}</span>
            </div>
            
            <div class="component-column qr-col">
                <span>QR: ${component.cau_kien_qr || ''}</span>
            </div>
        </div>
    `;
        }

        function generateSafeId(text) {
            return text.replace(/[^a-zA-Z0-9]/g, '_');
        }

        function renderHierarchicalData(data) {
            const container = document.getElementById('dataContainer');
            container.innerHTML = '';

            if (Object.keys(data).length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 50px; color: #666;">Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã</div>';
                return;
            }

            Object.values(data).forEach(order => {
                const safeOrderId = generateSafeId(order.orderId);
                const orderElement = document.createElement('div');
                orderElement.className = 'order-item';
                orderElement.id = `order-${safeOrderId}`;

                const displayGroupCount = Object.keys(order.displayGroups).length;
                orderElement.innerHTML = `
                    <div class="order-header" onclick="toggleOrderExpansion('${safeOrderId}')">
                        <div class="order-info">
                            <div class="order-title">
                                <span>üìã</span>
                                <span>${order.orderId}</span>
                            </div>
                            <div class="order-summary">
                                ${order.customerName} ‚Ä¢ ${displayGroupCount} nh√≥m ‚Ä¢ 
                                ${order.totalComponents} c·∫•u ki·ªán ‚Ä¢ ${formatNumber(order.totalWeight)} kg
                            </div>
                        </div>
                        <div class="order-actions">
                            <button class="print-btn" onclick="printOrderLabels('${order.orderId}', event)">
                                üñ®Ô∏è In Tem
                            </button>
                            <span class="expand-icon">‚ñº</span>
                        </div>
                    </div>
                    <div class="order-content">
                        <div class="display-groups-container" data-order-id="${order.orderId}">
                        </div>
                    </div>
                `;

                container.appendChild(orderElement);
            });
        }

        function loadDisplayGroups(orderId) {
            const order = groupedData[orderId];
            if (!order) return;

            const container = document.querySelector(`[data-order-id="${orderId}"]`);
            if (!container) return;

            // X√ìA D√íNG: if (container.hasChildNodes()) return;
            // Lu√¥n clear v√† render l·∫°i
            container.innerHTML = '';

            Object.values(order.displayGroups).forEach(displayGroup => {
                const safeDisplayName = generateSafeId(displayGroup.displayName);
                const safeOrderId = generateSafeId(orderId);

                const displayElement = document.createElement('div');
                displayElement.className = 'display-group';

                displayElement.innerHTML = `
            <div class="display-group-header" onclick="toggleDisplayGroupExpansion('${orderId}', '${displayGroup.displayName}')">
                <label onclick="event.stopPropagation();toggleSelectAllInGroup('${orderId}','${displayGroup.displayName}',this)">
                    <input type="checkbox" style="width: 7mm; height: 6mm;" data-order-id="${orderId}" data-group-name="${displayGroup.displayName}">
                </label>
                <div class="display-group-info">
                    <div class="display-group-title">
                        <span>üìÅ</span>
                        <span>${displayGroup.displayName}</span>
                    </div>
                    <div class="display-group-summary">
                        ${displayGroup.components.length} s·∫£n ph·∫©m ‚Ä¢ ${displayGroup.componentCount} c·∫•u ki·ªán ‚Ä¢ ${formatNumber(displayGroup.totalWeight)} kg
                    </div>
                </div>
                <div class="order-actions">
                    <button class="print-btn-nhom" onclick="printCheckedComponents('${orderId}', '${displayGroup.displayName}', event)" style="background: #1976d2; color: #fff; font-size: 12px; padding: 8px 15px;">
                        üñ®Ô∏è In Nh√≥m
                    </button>
                    <span class="expand-icon">‚ñº</span>
                </div>
            </div>
            <div class="display-group-content">
                <div class="components-container" data-display-group="${orderId}|||${displayGroup.displayName}">
                </div>
            </div>
        `;

                container.appendChild(displayElement);
            });
        }

        function loadComponents(orderId, displayGroupName) {
            const order = groupedData[orderId];
            if (!order || !order.displayGroups[displayGroupName]) return;

            const container = document.querySelector(`[data-display-group="${orderId}|||${displayGroupName}"]`);
            if (!container) return;

            container.innerHTML = '';

            order.displayGroups[displayGroupName].components.forEach((component, idx) => {
                const componentDiv = document.createElement('div');
                componentDiv.innerHTML = createComponentCardHTML(component, idx, orderId, displayGroupName);
                container.appendChild(componentDiv.firstElementChild);
            });
        }

        function toggleOrderExpansion(safeOrderId) {
            const orderElement = document.getElementById(`order-${safeOrderId}`);

            if (orderElement.classList.contains('expanded')) {
                orderElement.classList.remove('expanded');
            } else {
                orderElement.classList.add('expanded');
                const originalOrderId = Object.keys(groupedData).find(id => generateSafeId(id) === safeOrderId);
                if (originalOrderId) {
                    loadDisplayGroups(originalOrderId);
                }
            }
        }

        function toggleDisplayGroupExpansion(orderId, displayGroupName) {
            const order = groupedData[orderId];
            if (!order || !order.displayGroups[displayGroupName]) return;

            const container = document.querySelector(`[data-display-group="${orderId}|||${displayGroupName}"]`);
            const displayGroupElement = container.closest('.display-group');

            if (displayGroupElement.classList.contains('expanded')) {
                displayGroupElement.classList.remove('expanded');
                container.innerHTML = ''; // ·∫®n ƒëi khi thu g·ªçn
            } else {
                displayGroupElement.classList.add('expanded');
                loadComponents(orderId, displayGroupName);
            }
        }

        // ===== PRINT FUNCTIONS - TEM 1 (70mm x 35mm) =====
        // CH√ö TH√çCH: H√†m in tem cho to√†n b·ªô ƒë∆°n h√†ng
        async function printOrderLabels(orderId, event) {
            event.stopPropagation();
            const group = groupedData[orderId];
            if (!group) return;

            document.getElementById('loadingOverlay').classList.add('show');
            const printContainer = document.getElementById('printContainer');
            printContainer.innerHTML = '';

            try {
                let labelCount = 0;
                const fragment = document.createDocumentFragment();

                // Collect all items from all display groups
                const allItems = [];
                Object.values(group.displayGroups).forEach(displayGroup => {
                    allItems.push(...displayGroup.components);
                });

                // L·ªçc ra c√°c item c√≥ c·∫•u ki·ªán
                const validItems = allItems.filter(item => item.cau_kien && item.cau_kien.trim() !== '');

                for (let i = 0; i < validItems.length; i++) {
                    const item = validItems[i];
                    labelCount++;
                    const labelPage = document.createElement('div');

                    // Th√™m class ƒë·∫∑c bi·ªát cho tem cu·ªëi c√πng
                    if (i === validItems.length - 1) {
                        labelPage.className = 'label-page last-label';
                    } else {
                        labelPage.className = 'label-page';
                    }

                    // CH√ö TH√çCH: T·∫°o QR code - s·ª≠ d·ª•ng item.cau_kien_qr
                    let qrHTML = '';
                    if (item.cau_kien_qr && item.cau_kien_qr.trim() !== '') {
                        const qrURL = generateQRCodeAPI(item.cau_kien_qr, 600);
                        qrHTML = `<img src="${qrURL}" alt="QR Code" style="width: 10mm; height: 10mm;" onerror="this.style.display='none'">`;
                    } else {
                        qrHTML = `<div style="width: 10mm; height: 10mm; border: 2px dashed #ccc; display: flex; align-items: center; justify-content: center; font-size: 8px; color: #999;">NO QR</div>`;
                    }

                    // CH√ö TH√çCH: ƒê√¢y l√† template HTML cho m·ªói tem in
                    // ƒê·ªÉ th√™m th√¥ng tin m·ªõi, s·ª≠a ƒë·ªïi c·∫•u tr√∫c HTML d∆∞·ªõi ƒë√¢y
                    labelPage.innerHTML = `
                        <div class="label-header">${item.ten_kh || ''}</div>
                        <div class="label-content">
                            <div class="label-info">
                                <div class="ten_sp">${item.ten_sp || ''}</div>
                                <div class="component-name">${item.cau_kien || ''}</div>
                                <div class="additional-info">${item.quy_cach || ''}</div>
                                <!-- CH√ö TH√çCH: TH√äM TH√îNG TIN M·ªöI V√ÄO ƒê√ÇY -->
                                <!-- V√≠ d·ª• th√™m kh·ªëi l∆∞·ª£ng:
                                <div class="additional-info">${item.khoi_luong || ''} kg</div>
                                -->
                                <!-- V√≠ d·ª• th√™m s·ªë l∆∞·ª£ng:
                                <div class="additional-info">SL: ${item.sl_san_xuat || 1}</div>
                                -->
                                <div class="additional-info">${item.quy_cach || ''}</div>
                            </div>
                            <div class="qr-container">
                                ${qrHTML}
                                <div class="qr-code-id">${item.don_hang_ct_id || ''}</div>
                                <!-- CH√ö TH√çCH: TH√äM TH√îNG TIN M·ªöI D∆Ø·ªöI QR CODE -->
                                <!-- V√≠ d·ª•:
                                <div class="qr-additional-info">${item.new_field || ''}</div>
                                -->
                            </div>
                        </div>
                    `;

                    fragment.appendChild(labelPage);
                    await new Promise(resolve => setTimeout(resolve, 50));
                }

                printContainer.appendChild(fragment);
                document.getElementById('loadingOverlay').classList.remove('show');

                if (labelCount > 0) {
                    setTimeout(() => { window.print(); }, 500);
                } else {
                    alert('Kh√¥ng c√≥ c·∫•u ki·ªán n√†o ƒë·ªÉ in trong ƒë∆°n h√†ng n√†y.');
                }

            } catch (error) {
                console.error('Error creating labels:', error);
                document.getElementById('loadingOverlay').classList.remove('show');
                alert('C√≥ l·ªói x·∫£y ra khi t·∫°o tem. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        }

        // CH√ö TH√çCH: H√†m in tem cho nh√≥m hi·ªÉn th·ªã (kh√¥ng s·ª≠ d·ª•ng trong giao di·ªán hi·ªán t·∫°i)
        async function printDisplayGroupLabels(orderId, displayGroupName, event) {
            event.stopPropagation();

            const order = groupedData[orderId];
            if (!order || !order.displayGroups[displayGroupName]) return;

            const displayGroup = order.displayGroups[displayGroupName];
            const componentsWithCauKien = displayGroup.components.filter(component =>
                component.cau_kien && component.cau_kien.trim() !== ''
            );

            document.getElementById('loadingOverlay').classList.add('show');
            const printContainer = document.getElementById('printContainer');
            printContainer.innerHTML = '';

            try {
                let labelCount = 0;
                const fragment = document.createDocumentFragment();

                for (let item of componentsWithCauKien) {
                    labelCount++;
                    const labelPage = document.createElement('div');
                    labelPage.className = 'label-page';

                    // CH√ö TH√çCH: Template t∆∞∆°ng t·ª± nh∆∞ printOrderLabels
                    let qrHTML = '';
                    if (item.cau_kien_qr && item.cau_kien_qr.trim() !== '') {
                        const qrURL = generateQRCodeAPI(item.cau_kien_qr, 600);
                        qrHTML = `<img src="${qrURL}" alt="QR Code" style="width: 10mm; height: 10mm;" onerror="this.style.display='none'">`;
                    } else {
                        qrHTML = `<div style="width: 10mm; height: 10mm; border: 2px dashed #ccc; display: flex; align-items: center; justify-content: center; font-size: 8px; color: #999;">NO QR</div>`;
                    }

                    labelPage.innerHTML = `
                        <div class="label-header">${item.ten_kh || ''}</div>
                        <div class="label-content">
                            <div class="label-info">
                                <div class="ten_sp">${item.ten_sp || ''}</div>
                                <div class="component-name">${item.cau_kien || ''}</div>
                                <!-- CH√ö TH√çCH: TH√äM TH√îNG TIN M·ªöI (t∆∞∆°ng t·ª± nh∆∞ h√†m tr√™n) -->
                            </div>
                            <div class="qr-container">
                                ${qrHTML}
                                <div class="qr-code-id">${item.don_hang_ct_id || ''}</div>
                                <!-- CH√ö TH√çCH: TH√äM TH√îNG TIN M·ªöI D∆Ø·ªöI QR CODE -->
                            </div>
                        </div>
                    `;

                    fragment.appendChild(labelPage);
                    await new Promise(resolve => setTimeout(resolve, 50));
                }

                printContainer.appendChild(fragment);
                document.getElementById('loadingOverlay').classList.remove('show');

                if (labelCount > 0) {
                    setTimeout(() => { window.print(); }, 500);
                } else {
                    alert('Kh√¥ng c√≥ c·∫•u ki·ªán n√†o ƒë·ªÉ in trong nh√≥m n√†y.');
                }

            } catch (error) {
                console.error('Error creating labels:', error);
                document.getElementById('loadingOverlay').classList.remove('show');
                alert('C√≥ l·ªói x·∫£y ra khi t·∫°o tem. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        }

        function updateSummary(data) {
            const totalOrders = Object.keys(data).length;
            let totalDisplayGroups = 0;
            let totalComponents = 0;
            let totalWeight = 0;

            Object.values(data).forEach(order => {
                totalDisplayGroups += order.totalDisplayGroups;
                totalComponents += order.totalComponents;
                totalWeight += order.totalWeight;
            });

            document.getElementById('totalOrders').textContent = formatNumber(totalOrders);
            document.getElementById('totalDisplayGroups').textContent = formatNumber(totalDisplayGroups);
            document.getElementById('totalComponents').textContent = formatNumber(totalComponents);
            document.getElementById('totalWeight').textContent = formatNumber(totalWeight) + ' kg';
            document.getElementById('summaryBar').style.display = 'flex';
        }

        const debouncedFilter = debounce((searchTerm) => {
            if (!searchTerm.trim()) {
                filteredData = allData;
            } else {
                const term = searchTerm.toLowerCase();
                // CH√ö TH√çCH: ƒê·ªÉ th√™m field m·ªõi v√†o t√¨m ki·∫øm, th√™m v√†o ƒëi·ªÅu ki·ªán filter d∆∞·ªõi ƒë√¢y
                filteredData = allData.filter(item =>
                    (item.don_hang_id && item.don_hang_id.toLowerCase().includes(term)) ||
                    (item.ten_kh && item.ten_kh.toLowerCase().includes(term)) ||
                    (item.ten_sp && item.ten_sp.toLowerCase().includes(term)) ||
                    (item.cau_kien && item.cau_kien.toLowerCase().includes(term)) ||
                    (item.hien_thi && item.hien_thi.toLowerCase().includes(term))
                    // || (item.new_field && item.new_field.toLowerCase().includes(term))  // Th√™m field m·ªõi
                );
            }

            groupedData = groupDataHierarchically(filteredData);
            renderHierarchicalData(groupedData);
            updateSummary(groupedData);
        }, 300);

        function showError(message) {
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorDiv').style.display = 'block';
        }

        function showData() {
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('dataContainer').style.display = 'block';
        }

        // CH√ö TH√çCH: H√†m kh·ªüi t·∫°o - t·∫£i d·ªØ li·ªáu t·ª´ API
        async function initialize() {
            try {
                let data = await fetchLSXData();
                // CH√ö TH√çCH: L·ªçc d·ªØ li·ªáu - lo·∫°i b·ªè c√°c d√≤ng c√≥ l·ªói
                data = data.filter(item =>
                    item.khoi_luong_dv &&
                    item.cau_kien_qr &&
                    item.khoi_luong_dv !== "#DIV/0!" &&
                    item.cau_kien_qr !== "#DIV/0!"
                    // && item.new_field !== "#DIV/0!"  // Th√™m filter cho field m·ªõi n·∫øu c·∫ßn
                );
                allData = data;
                filteredData = data;
                groupedData = groupDataHierarchically(filteredData);

                renderHierarchicalData(groupedData);
                updateSummary(groupedData);
                showData();
            } catch (error) {
                showError(`Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu: ${error.message}`);
            }
        }
        // Make functions global
        window.toggleOrderExpansion = toggleOrderExpansion;
        window.toggleDisplayGroupExpansion = toggleDisplayGroupExpansion;
        window.printOrderLabels = printOrderLabels;
        window.printDisplayGroupLabels = printDisplayGroupLabels;

        function toggleSelectAllInGroup(orderId, displayGroupName, label) {
            const groupCheckbox = label.querySelector('input[type="checkbox"]');
            const checked = groupCheckbox.checked;
            // Ch·ªçn t·∫•t c·∫£ ho·∫∑c b·ªè ch·ªçn t·∫•t c·∫£ c√°c c·∫•u ki·ªán trong nh√≥m
            const container = document.querySelector(`[data-display-group="${orderId}|||${displayGroupName}"]`);
            if (!container) return;
            const checkboxes = container.querySelectorAll('.component-checkbox');
            checkboxes.forEach(cb => cb.checked = checked);
        }

        // CH√ö TH√çCH: H√†m in tem cho c√°c c·∫•u ki·ªán ƒë√£ ch·ªçn trong m·ªôt nh√≥m
        function printCheckedComponents(orderId, displayGroupName, event) {
            event.stopPropagation();
            const order = groupedData[orderId];
            if (!order || !order.displayGroups[displayGroupName]) return;

            const displayGroup = order.displayGroups[displayGroupName];
            const container = document.querySelector(`[data-display-group="${orderId}|||${displayGroupName}"]`);
            if (!container) return;

            // L·∫•y c√°c checkbox ƒë√£ tick
            const checkboxes = container.querySelectorAll('.component-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 c·∫•u ki·ªán ƒë·ªÉ in!');
                return;
            }
            const selectedIdx = Array.from(checkboxes).map(cb => parseInt(cb.getAttribute('data-idx')));
            const selectedComponents = displayGroup.components.filter((c, idx) => selectedIdx.includes(idx));

            document.getElementById('loadingOverlay').classList.add('show');
            const printContainer = document.getElementById('printContainer');
            printContainer.innerHTML = '';

            (async () => {
                let labelCount = 0;
                const fragment = document.createDocumentFragment();
                let imgPromises = [];

                // CH√ö TH√çCH: X·ª≠ l√Ω t·ª´ng component ƒë√£ ch·ªçn v√† s·ªë l∆∞·ª£ng t∆∞∆°ng ·ª©ng
                for (let item of selectedComponents) {
                    // L·∫•y s·ªë l∆∞·ª£ng t·ª´ input ch·ªânh s·ª≠a
                    const idx = displayGroup.components.indexOf(item);
                    let soLuong = parseInt(item.sl_san_xuat) || 1;
                    const input = container.querySelector(`input.sl-input[data-idx="${idx}"]`);
                    if (input && !isNaN(parseInt(input.value))) {
                        soLuong = parseInt(input.value);
                    }

                    // T·∫°o tem theo s·ªë l∆∞·ª£ng
                    for (let i = 0; i < soLuong; i++) {
                        labelCount++;
                        const labelPage = document.createElement('div');
                        labelPage.className = 'label-page';

                        // CH√ö TH√çCH: T·∫°o QR code cho t·ª´ng tem ƒë∆∞·ª£c ch·ªçn
                        let qrHTML = '';
                        if (item.cau_kien_qr && item.cau_kien_qr.trim() !== '') {
                            const qrURL = generateQRCodeAPI(item.cau_kien_qr, 600);
                            qrHTML = `<img src="${qrURL}" alt="QR Code" style="width: 10mm; height: 10mm;" onerror="this.style.display='none'">`;
                        } else {
                            qrHTML = `<div style="width: 10mm; height: 10mm; border: 2px dashed #ccc; display: flex; align-items: center; justify-content: center; font-size: 8px; color: #999;">NO QR</div>`;
                        }

                        // CH√ö TH√çCH: Template HTML gi·ªëng nh∆∞ h√†m printOrderLabels
                        // ƒê·ªÉ th√™m th√¥ng tin m·ªõi, s·ª≠a ƒë·ªïi t∆∞∆°ng t·ª± nh∆∞ h√†m tr√™n
                        labelPage.innerHTML = `
                    <div class="label-header">${item.ten_kh || ''}</div>
                    <div class="label-content">
                        <div class="label-info">
                            <div class="ten_sp">${item.ten_sp || ''}</div>
                            <div class="component-name">${item.cau_kien || ''}</div>
                            <!-- CH√ö TH√çCH: TH√äM TH√îNG TIN M·ªöI V√ÄO ƒê√ÇY (t∆∞∆°ng t·ª± nh∆∞ h√†m tr√™n) -->
                        </div>
                        <div class="qr-container">
                            ${qrHTML}
                            <div class="qr-code-id">${item.don_hang_ct_id || ''}</div>
                            <!-- CH√ö TH√çCH: TH√äM TH√îNG TIN M·ªöI D∆Ø·ªöI QR CODE -->
                        </div>
                    </div>
                `;

                        const img = labelPage.querySelector('img');
                        if (img) {
                            imgPromises.push(new Promise(resolve => {
                                img.onload = resolve;
                                img.onerror = resolve;
                            }));
                        }

                        fragment.appendChild(labelPage);
                    }
                }

                printContainer.appendChild(fragment);
                document.getElementById('loadingOverlay').classList.remove('show');

                if (labelCount > 0) {
                    // ƒê·ª£i t·∫•t c·∫£ ·∫£nh QR code trong printContainer load xong r·ªìi m·ªõi in
                    const imgs = printContainer.querySelectorAll('img');
                    if (imgs.length > 0) {
                        Promise.all(Array.from(imgs).map(img => new Promise(resolve => {
                            if (img.complete) resolve();
                            else {
                                img.onload = resolve;
                                img.onerror = resolve;
                            }
                        }))).then(() => {
                            setTimeout(() => { window.print(); }, 100);
                        });
                    } else {
                        setTimeout(() => { window.print(); }, 100);
                    }
                } else {
                    alert('Kh√¥ng c√≥ c·∫•u ki·ªán n√†o ƒë·ªÉ in.');
                }
            })();
        }

        // H√†m auto-scroll khi k√©o g·∫ßn edge
        function handleAutoScroll(e) {
            const threshold = 50; // kho·∫£ng c√°ch t·ª´ edge ƒë·ªÉ b·∫Øt ƒë·∫ßu scroll
            const scrollSpeed = 5; // t·ªëc ƒë·ªô scroll
            const scrollContainer = document.querySelector('.data-container');

            if (!scrollContainer || !isDragging) return;

            const rect = scrollContainer.getBoundingClientRect();
            const mouseY = e.clientY;

            if (mouseY < rect.top + threshold) {
                // Scroll l√™n
                if (autoScrollTimer) clearInterval(autoScrollTimer);
                autoScrollTimer = setInterval(() => {
                    scrollContainer.scrollTop -= scrollSpeed;
                }, 16);
            } else if (mouseY > rect.bottom - threshold) {
                // Scroll xu·ªëng
                if (autoScrollTimer) clearInterval(autoScrollTimer);
                autoScrollTimer = setInterval(() => {
                    scrollContainer.scrollTop += scrollSpeed;
                }, 16);
            } else {
                // D·ª´ng scroll
                if (autoScrollTimer) {
                    clearInterval(autoScrollTimer);
                    autoScrollTimer = null;
                }
            }
        }

        // H√†m x·ª≠ l√Ω range selection th√¥ng minh (kh√¥ng reset c√°c checkbox kh√°c)
        function handleRangeSelection(currentCheckbox) {
            if (!lastClickedCheckbox || !isShiftPressed) return;

            const orderId = currentCheckbox.getAttribute('data-order-id');
            const groupName = currentCheckbox.getAttribute('data-group-name');
            const lastOrderId = lastClickedCheckbox.getAttribute('data-order-id');
            const lastGroupName = lastClickedCheckbox.getAttribute('data-group-name');

            // Ch·ªâ x·ª≠ l√Ω trong c√πng m·ªôt nh√≥m
            if (orderId !== lastOrderId || groupName !== lastGroupName) return;

            const container = document.querySelector(`[data-display-group="${orderId}|||${groupName}"]`);
            if (!container) return;

            const allCheckboxes = Array.from(container.querySelectorAll('.component-checkbox'));
            const startIndex = allCheckboxes.indexOf(lastClickedCheckbox);
            const endIndex = allCheckboxes.indexOf(currentCheckbox);

            if (startIndex !== -1 && endIndex !== -1) {
                const minIndex = Math.min(startIndex, endIndex);
                const maxIndex = Math.max(startIndex, endIndex);

                const targetState = currentCheckbox.checked;

                // Ch·ªâ thay ƒë·ªïi tr·∫°ng th√°i c·ªßa c√°c checkbox trong range
                for (let i = minIndex; i <= maxIndex; i++) {
                    allCheckboxes[i].checked = targetState;
                }
            }
        }

        // H√†m x·ª≠ l√Ω drag selection th√¥ng minh
        function handleDragSelection(currentCheckbox) {
            if (!isDragging || !dragStartCheckbox) return;

            const orderId = currentCheckbox.getAttribute('data-order-id');
            const groupName = currentCheckbox.getAttribute('data-group-name');
            const dragOrderId = dragStartCheckbox.getAttribute('data-order-id');
            const dragGroupName = dragStartCheckbox.getAttribute('data-group-name');

            // Ch·ªâ x·ª≠ l√Ω trong c√πng m·ªôt nh√≥m
            if (orderId !== dragOrderId || groupName !== dragGroupName) return;

            const container = document.querySelector(`[data-display-group="${orderId}|||${groupName}"]`);
            if (!container) return;

            const allCheckboxes = Array.from(container.querySelectorAll('.component-checkbox'));
            const startIndex = allCheckboxes.indexOf(dragStartCheckbox);
            const endIndex = allCheckboxes.indexOf(currentCheckbox);

            if (startIndex !== -1 && endIndex !== -1) {
                const minIndex = Math.min(startIndex, endIndex);
                const maxIndex = Math.max(startIndex, endIndex);

                // L∆∞u tr·∫°ng th√°i hi·ªán t·∫°i tr∆∞·ªõc khi thay ƒë·ªïi
                const currentStates = allCheckboxes.map(cb => cb.checked);

                // Reset v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu
                if (window.dragOriginalStates) {
                    allCheckboxes.forEach((cb, idx) => {
                        cb.checked = window.dragOriginalStates[idx];
                    });
                }

                // Ch·ªçn c√°c checkbox trong v√πng drag m·ªõi
                for (let i = minIndex; i <= maxIndex; i++) {
                    allCheckboxes[i].checked = true;
                }
            }
        }

        // X·ª≠ l√Ω khi click checkbox
        function handleCheckboxChange(checkbox) {
            if (isShiftPressed && lastClickedCheckbox) {
                // N·∫øu ƒëang gi·ªØ Shift, th·ª±c hi·ªán range selection
                handleRangeSelection(checkbox);
            } else {
                // L∆∞u checkbox ƒë∆∞·ª£c click cu·ªëi c√πng
                lastClickedCheckbox = checkbox;
            }
        }

        // X·ª≠ l√Ω khi nh·∫•n chu·ªôt xu·ªëng
        function handleMouseDown(checkbox, event) {
            if (isShiftPressed) {
                event.preventDefault();
                isDragging = true;
                dragStartCheckbox = checkbox;

                // L∆∞u tr·∫°ng th√°i ban ƒë·∫ßu c·ªßa t·∫•t c·∫£ checkbox trong nh√≥m
                const orderId = checkbox.getAttribute('data-order-id');
                const groupName = checkbox.getAttribute('data-group-name');
                const container = document.querySelector(`[data-display-group="${orderId}|||${groupName}"]`);
                if (container) {
                    const allCheckboxes = Array.from(container.querySelectorAll('.component-checkbox'));
                    window.dragOriginalStates = allCheckboxes.map(cb => cb.checked);
                }

                checkbox.checked = true;
            } else {
                lastClickedCheckbox = checkbox;
            }
        }

        // X·ª≠ l√Ω khi di chu·ªôt qua checkbox kh√°c
        function handleMouseEnter(checkbox, event) {
            if (isShiftPressed && isDragging) {
                handleDragSelection(checkbox);
                handleAutoScroll(event); // Th√™m auto-scroll
            }
        }

        // Th√™m event listener cho mousemove ƒë·ªÉ x·ª≠ l√Ω auto-scroll
        document.addEventListener('mousemove', function (e) {
            if (isShiftPressed && isDragging) {
                handleAutoScroll(e);
            }
        });

        // C·∫≠p nh·∫≠t x·ª≠ l√Ω khi th·∫£ chu·ªôt
        document.addEventListener('mouseup', function (e) {
            if (isShiftPressed && isDragging) {
                isDragging = false;
                dragStartCheckbox = null;
                window.dragOriginalStates = null;

                // D·ª´ng auto-scroll
                if (autoScrollTimer) {
                    clearInterval(autoScrollTimer);
                    autoScrollTimer = null;
                }
            }
        });

        // C·∫≠p nh·∫≠t event listeners cho Shift key
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Shift') {
                isShiftPressed = true;
                document.body.style.cursor = 'crosshair';
                document.body.classList.add('shift-mode');
            }
        });

        document.addEventListener('keyup', function (e) {
            if (e.key === 'Shift') {
                isShiftPressed = false;
                document.body.style.cursor = '';
                document.body.classList.remove('shift-mode');
                isDragging = false;
                dragStartCheckbox = null;
                window.dragOriginalStates = null;

                // D·ª´ng auto-scroll
                if (autoScrollTimer) {
                    clearInterval(autoScrollTimer);
                    autoScrollTimer = null;
                }
            }
        });

        // Th√™m event listener ƒë·ªÉ d·ª´ng auto-scroll khi chu·ªôt r·ªùi kh·ªèi container
        document.addEventListener('mouseleave', function (e) {
            if (autoScrollTimer) {
                clearInterval(autoScrollTimer);
                autoScrollTimer = null;
            }
        });

        // Make functions global
        window.toggleOrderExpansion = toggleOrderExpansion;
        window.toggleDisplayGroupExpansion = toggleDisplayGroupExpansion;
        window.printOrderLabels = printOrderLabels;
        window.printDisplayGroupLabels = printDisplayGroupLabels;
        window.printCheckedComponents = printCheckedComponents;
        window.toggleSelectAllInGroup = toggleSelectAllInGroup;

        // Th√™m v√†o cu·ªëi ph·∫ßn Make functions global
        window.handleCheckboxChange = handleCheckboxChange;
        window.handleMouseDown = handleMouseDown;
        window.handleMouseEnter = handleMouseEnter;

        // Event listeners
        document.addEventListener('DOMContentLoaded', function () {
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', function () {
                debouncedFilter(this.value);
            });

            initialize();
        });
    </script>
</body>

</html>
