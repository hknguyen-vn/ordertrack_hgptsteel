<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HGPT Steel ‚Äî Tem VT_QR (70√ó35mm ‚Ä¢ 3 tem/trang ‚Ä¢ xoay ngang)</title>
  <style>
    :root{
      /* 1 trang: ngang 105mm, cao 70mm = 3 tem d·ªçc 35√ó70mm */
      --sheet-w: 105mm;    /* 3 tem x 35mm */
      --sheet-h: 70mm;     /* cao 70mm */
      --label-w: 35mm;
      --label-h: 70mm;

      /* B√™n trong m·ªói label (sau khi xoay) l√† v√πng 70√ó35mm nh∆∞ m·∫´u VT_QR c≈© */
      --pad: 2mm;
      --qr: 20mm;
      --font: "Times New Roman", Times, serif;
    }

    *{ box-sizing: border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:#f3f5f8;
      color:#0f172a;
    }
    .wrap{
      max-width:960px;
      margin:24px auto;
      padding:16px;
      background:#fff;
      border-radius:14px;
      box-shadow:0 8px 24px rgba(2,6,23,.08);
    }
    h1{ font-size:20px; margin:0 0 12px; }
    .row{ display:flex; gap:12px; align-items:center; margin-bottom:8px; flex-wrap:wrap; }
    button{
      padding:10px 18px;
      border-radius:10px;
      border:2px solid #ffad56;
      background:#fff;
      color:#ff7a00;
      font-weight:700;
      cursor:pointer;
    }
    button:hover{ background:#ffad56; color:#fff; }
    .status{ font-size:13px; color:#475569; margin-left:8px; }
    .note{ font-size:12px; color:#64748b; margin-top:4px; }

    .print-container{ display:none; }

    /* ================== CH·∫æ ƒê·ªò IN ================== */
    @media print{
      @page{
        size: var(--sheet-w) var(--sheet-h);
        margin:0;
      }

      .wrap{ display:none !important; }
      body{
        background:#fff;
      }

      .print-container{
        display:block;
        position:absolute;
        inset:0;
        padding:0;
      }

      /* M·ªói .sheet = 1 trang 105√ó70mm, chia l∆∞·ªõi 3 label 35√ó70mm */
      .sheet{
        width: var(--sheet-w);
        height: var(--sheet-h);
        display:grid;
        grid-template-columns: repeat(3, var(--label-w));
        grid-auto-rows: var(--label-h);
        gap: 0;
        background:#fff;
        position: relative;
        break-inside: avoid;
        page-break-after: always;
      }

      /* 2 ƒë∆∞·ªùng n√©t ƒë·ª©t ngƒÉn 3 tem */
      .sheet::before,
      .sheet::after{
        content:"";
        position:absolute;
        top:0; bottom:0;
        width:0;
        border-left:1px dashed #999;
        pointer-events:none;
      }
      .sheet::before{ left: var(--label-w); }
      .sheet::after{  left: calc(var(--label-w) * 2); }

      /* Khung tem 35√ó70mm (ch∆∞a xoay n·ªôi dung) */
      .label{
        width: var(--label-w);
        height: var(--label-h);
        position: relative;
        background:#fff;
        overflow: hidden;
      }

      /* V√πng n·ªôi dung xoay: sau khi xoay s·∫Ω th√†nh 70√ó35mm */
      .rotor{
        position:absolute;
        top:0;
        left:0;
        width:  var(--label-h);   /* 70mm */
        height: var(--label-w);   /* 35mm */
        transform-origin: top left;

        /* ƒê·∫ßu tem v·ªÅ b√™n ph·∫£i nh∆∞ template 3 tem */
        transform: translateX(var(--label-w)) rotate(90deg);

        padding: var(--pad);
        box-sizing: border-box;

        display:flex;
        align-items:stretch;
        justify-content:flex-start;
      }

      /* B√™n trong rotor: layout gi·ªëng m·∫´u VT_QR c≈© ‚Äì QR tr√°i, Text ph·∫£i */
      .inner{
        width:100%;
        height:100%;
        display:flex;
        align-items:center;
        justify-content:flex-start;
        gap: 3mm;
      }

      .qr{
        flex: 0 0 var(--qr);
        width: var(--qr);
        height: var(--qr);
        display:flex;
        align-items:center;
        justify-content:center;
      }
      .qr img{
        display:block;
        width:100% !important;
        height:100% !important;
      }

      .text{
        flex: 1 1 0;
        min-width:0;
        line-height:1.06;
      }
      .ma{
        font-family: var(--font);
        font-weight:700;
        font-size:14pt;
      }
      .ten{
        font-family: var(--font);
        font-weight:700;
        font-size:12pt;
        text-transform:uppercase;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <img src="https://hgptsteel.com/wp-content/uploads/2025/06/cropped-HGPT-STEEL-1-1.png" alt="HGPT Logo" style="height:38px; vertical-align:middle;">
    <h1>HGPT STEEL ‚Äî Tem VT_QR (3 tem/trang)</h1>
    <div class="row">
      <button id="btnPrint">üñ®Ô∏è In tem VT_QR</button>
      <a id="sheetLink" href="#" class="link" target="_blank">üîó M·ªü link Sheet n·ªÅn</a>
      <span class="status" id="status"><i class="fa-solid fa-check fa-xl" style="color:#004ffa;"></i> S·∫µn s√†ng in r·ªìi :)</span>
    </div>
    <div class="note">
      Kh·ªï in: <b>70√ó105mm</b> ‚Ä¢ <b>3 tem 70√ó35mm/trang</b> (xoay ngang).<br>
      D·ªØ li·ªáu t·ª´ b·∫£ng <b>VT_QR</b> (AppSheet). QR b√™n tr√°i (t·ª´ <b>MAHANG</b>), b√™n ph·∫£i: <b>MAHANG</b> &amp; <b>TENMAU</b> (in hoa), nh√¢n b·∫£n theo <b>SL</b>.
    </div>
  </div>

  <div class="print-container" id="printContainer"></div>

  <script>
    // ===== C·∫§U H√åNH APPSHEET VT_QR =====
    const appId     = '977c97bd-47e4-441c-b564-fe28574e9d74';
    const accessKey = 'V2-sJNk8-IQldL-7uQ80-Iekic-SvMjg-FPH9j-DFCgG-v97aL';
    const region    = 'www'; // 'www', 'eu', ...

    document.addEventListener('DOMContentLoaded', () => {
      const $             = (s)=>document.querySelector(s);
      const statusEl      = $('#status');
      const printContainer= $('#printContainer');
      const btnPrint      = $('#btnPrint');

      // L·∫•y d·ªØ li·ªáu VT_QR t·ª´ AppSheet
      async function fetchVTQR() {
        const url  = `https://${region}.appsheet.com/api/v2/apps/${appId}/tables/VT_QR/Action`;
        const body = {
          Action: 'Find',
          Properties: {},
          Selector: 'Filter(VT_QR, true)'
        };
        const resp = await fetch(url, {
          method: 'POST',
          headers: {
            'ApplicationAccessKey': accessKey,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body)
        });

        const txt = await resp.text();
        if (!resp.ok) {
          throw new Error(`VT_QR HTTP ${resp.status} - ${txt.slice(0,200)}`);
        }
        const data = JSON.parse(txt);
        if (!Array.isArray(data)) {
          throw new Error('D·ªØ li·ªáu VT_QR tr·∫£ v·ªÅ kh√¥ng ph·∫£i m·∫£ng.');
        }
        return data;
      }

      // L·∫•y gi√° tr·ªã theo nhi·ªÅu t√™n kh√≥a (case-insensitive)
      function pick(obj, names) {
        for (const n of names) {
          if (obj[n] !== undefined && obj[n] !== null && obj[n] !== '') return obj[n];
          const hit = Object.keys(obj).find(k => k.toLowerCase() === n.toLowerCase());
          if (hit && obj[hit] !== '') return obj[hit];
        }
        return '';
      }

      // T·∫°o URL QR t·ª´ MAHANG
      function qrURL(mahang, size=400) {
        const v = (mahang || '').toString().trim();
        return `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encodeURIComponent(v)}`;
      }

      // T·∫°o 1 tem (label) theo layout 3-tem/xoay ngang
      function makeLabel({ MAHANG, TENMAU }) {
        const label = document.createElement('div');
        label.className = 'label';
        label.innerHTML = `
          <div class="rotor">
            <div class="inner">
              <div class="qr">
                <img src="${qrURL(MAHANG)}" alt="QR">
              </div>
              <div class="text">
                <div class="ma">${MAHANG}</div>
                <div class="ten">${(TENMAU || '').toString().toUpperCase()}</div>
              </div>
            </div>
          </div>
        `;
        return label;
      }

      // H√†m in t·ª´ VT_QR, 3 tem/trang
      async function printFromVTQR() {
        statusEl.textContent = 'ƒêang t·∫£i d·ªØ li·ªáu VT_QR...';
        printContainer.innerHTML = '';

        let rows;
        try {
          rows = await fetchVTQR();
        } catch (e) {
          statusEl.textContent = 'L·ªói t·∫£i VT_QR';
          alert('Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c d·ªØ li·ªáu VT_QR:\n' + e.message);
          return;
        }

        if (!rows.length) {
          statusEl.textContent = 'Kh√¥ng c√≥ d·ªØ li·ªáu VT_QR.';
          alert('Kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá trong VT_QR.');
          return;
        }

        statusEl.textContent = 'ƒêang t·∫°o tem...';

        let sheet = null;
        let cell  = 0;   // ƒë·∫øm tem tr√™n 1 trang (t·ªëi ƒëa 3)
        let total = 0;   // t·ªïng s·ªë tem

        for (const r of rows) {
          const MAHANG = (pick(r, ['MAHANG','mahang','M√É H√ÄNG']) || '').toString().trim();
          const TENMAU = (pick(r, ['TENMAU','tenmau','T√™n m·∫´u']) || '').toString().trim();
          const SLraw  = pick(r, ['SL','sl','S·ªë l∆∞·ª£ng']);
          const SL     = Number.parseInt(SLraw || 1, 10) > 0 ? Number.parseInt(SLraw,10) : 1;

          if (!MAHANG) continue;

          for (let i = 0; i < SL; i++) {
            // T·∫°o sheet m·ªõi n·∫øu ch∆∞a c√≥ ho·∫∑c ƒë√£ ƒë·ªß 3 tem
            if (!sheet || cell === 3) {
              sheet = document.createElement('div');
              sheet.className = 'sheet';
              printContainer.appendChild(sheet);
              cell = 0;
            }

            const labelEl = makeLabel({ MAHANG, TENMAU });
            sheet.appendChild(labelEl);
            cell++;
            total++;
          }
        }

        if (!total) {
          statusEl.textContent = 'Kh√¥ng c√≥ b·∫£n ghi h·ª£p l·ªá.';
          alert('C√≥ d·ªØ li·ªáu nh∆∞ng thi·∫øu MAHANG/SL h·ª£p l·ªá.');
          return;
        }

        // Ch·ªù ·∫£nh QR load xong r·ªìi m·ªõi in
        const imgs = printContainer.querySelectorAll('img');
        if (imgs.length) {
          await Promise.all(
            Array.from(imgs).map(img => new Promise(res => {
              if (img.complete) res();
              else {
                img.onload  = () => res();
                img.onerror = () => res();
              }
            }))
          );
        }

        statusEl.textContent = `ƒê√£ t·∫°o ${total} tem ‚Ä¢ m·ªü h·ªôp tho·∫°i in...`;
        setTimeout(() => {
          window.print();
          statusEl.textContent = 'S·∫µn s√†ng';
        }, 120);
      }

      if (btnPrint) {
        btnPrint.addEventListener('click', printFromVTQR);
      }
    });
  </script>
</body>
</html>
